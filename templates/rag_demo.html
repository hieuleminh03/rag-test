{% extends "base.html" %}

{% block title %}RAG Generator - Tạo Test Case{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <div>
        <h2><i class="fas fa-magic me-2"></i>RAG Generator</h2>
        <p class="text-muted mb-0">Tạo Test Case tự động từ nhiều file tài liệu (API doc, business logic, error mapping, database)</p>
    </div>
</div>

<div class="row">
    <div class="col-lg-8">
        <!-- API Input -->
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-upload me-2"></i>Upload tài liệu để phân tích</h5>
            </div>
            <div class="card-body">
                <form id="ragForm" enctype="multipart/form-data">
                    <!-- Main Documents -->
                    <div class="mb-4">
                        <label for="mainFileInput" class="form-label">
                            <i class="fas fa-star text-warning me-1"></i>
                            <strong>Tài liệu chính</strong> (API Design, API Docs)
                        </label>
                        <input type="file" class="form-control" id="mainFileInput" name="main_files" multiple 
                               accept=".txt,.md,.json,.doc,.docx,.pdf" onchange="handleMainFileSelection()">
                        <div class="form-text text-muted">
                            Tài liệu chính chứa thông số kỹ thuật và yêu cầu API
                        </div>
                        
                        <div id="mainUploadStatus" class="mt-2" style="display: none;">
                            <div class="progress">
                                <div class="progress-bar bg-warning" role="progressbar" style="width: 0%"></div>
                            </div>
                            <small class="text-muted mt-1 d-block">Đang xử lý tài liệu chính...</small>
                        </div>
                        
                        <div id="mainFilesList" class="mt-2">
                            <!-- Main files will appear here -->
                        </div>
                    </div>
                    
                    <!-- Reference Documents -->
                    <div class="mb-3">
                        <label for="refFileInput" class="form-label">
                            <i class="fas fa-book text-info me-1"></i>
                            <strong>Tài liệu tham khảo</strong> (Tùy chọn)
                        </label>
                        <input type="file" class="form-control" id="refFileInput" name="ref_files" multiple 
                               accept=".txt,.md,.json,.doc,.docx,.pdf" onchange="handleRefFileSelection()">
                        <div class="form-text text-muted">
                            Tài liệu hỗ trợ, ví dụ hoặc tài liệu ngữ cảnh bổ sung
                        </div>
                        
                        <div id="refUploadStatus" class="mt-2" style="display: none;">
                            <div class="progress">
                                <div class="progress-bar bg-info" role="progressbar" style="width: 0%"></div>
                            </div>
                            <small class="text-muted mt-1 d-block">Đang xử lý tài liệu tham khảo...</small>
                        </div>
                        
                        <div id="refFilesList" class="mt-2">
                            <!-- Reference files will appear here -->
                        </div>
                    </div>
                    
                    <!-- File Preview Area -->
                    <div id="filePreviewArea" class="mb-3" style="display: none;">
                        <label class="form-label">Files đã chọn:</label>
                        <div id="fileList" class="border rounded p-3 bg-light">
                            <!-- File list will be populated here -->
                        </div>
                        <div class="mt-2">
                            <button type="button" class="btn btn-sm btn-outline-secondary" onclick="clearFiles()">
                                <i class="fas fa-times me-1"></i>Xóa tất cả
                            </button>
                            <button type="button" class="btn btn-sm btn-outline-info" onclick="previewContent()">
                                <i class="fas fa-eye me-1"></i>Xem nội dung
                            </button>
                        </div>
                    </div>
                    
                    <!-- Content Preview (hidden textarea for processing) -->
                    <textarea id="apiInput" name="api_input" style="display: none;"></textarea>
                    
                    <!-- Active Prompt Indicator -->
                    <div id="activePromptIndicator" class="alert alert-info py-2 mb-3">
                        <i class="fas fa-info-circle me-1"></i>
                        <small><strong>Prompt đang sử dụng:</strong> <span id="activePromptName">Đang tải...</span> | 
                        <a href="{{ url_for('prompt_manager') }}" class="alert-link">Quản lý Prompt</a></small>
                    </div>
                    
                    <div class="d-flex gap-2 justify-content-end">
                        <button type="button" class="btn btn-outline-secondary" onclick="clearInput()">
                            <i class="fas fa-eraser me-1"></i>Xóa
                        </button>
                        <div class="d-flex gap-2 flex-wrap">
                            <button type="button" class="btn btn-outline-secondary" onclick="reviewPrompt()" id="promptBtn">
                                <i class="fas fa-eye me-1"></i>Xem Prompt
                            </button>
                            
                            <!-- Generation Mode Selection -->
                            <div class="me-3 d-flex align-items-center">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="usePlanning">
                                    <label class="form-check-label" for="usePlanning">
                                        <i class="fas fa-brain me-1"></i>Plan mode
                                    </label>
                                </div>
                            </div>
                            
                            <button type="button" class="btn btn-primary" onclick="startGeneration()" id="generateBtn">
                                <i class="fas fa-play me-1"></i>Tạo Test Case
                            </button>
                        </div>
                    </div>
                </form>
            </div>
        </div>

        <!-- Generation Progress -->
        <div class="card mt-4" id="progressCard" style="display: none;">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-cogs me-2"></i>Đang tạo Test Case</h5>
            </div>
            <div class="card-body" id="progressContent">
                <!-- Progress will appear here -->
            </div>
        </div>

        <!-- Generated Results -->
        <div class="card mt-4" id="resultsCard" style="display: none;">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0"><i class="fas fa-list-check me-2"></i>Test Case đã tạo</h5>
                <div class="btn-group">
                    <button type="button" class="btn btn-sm btn-outline-info" onclick="showFinalPrompt()">
                        <i class="fas fa-eye me-1"></i>Xem Prompt đã gửi
                    </button>
                    <button type="button" class="btn btn-sm btn-outline-primary" onclick="exportResults()">
                        <i class="fas fa-download me-1"></i>Xuất JSON
                    </button>
                    <button type="button" class="btn btn-sm btn-outline-success" onclick="exportToExcel()">
                        <i class="fas fa-file-excel me-1"></i>Xuất Excel
                    </button>
                </div>
            </div>
            <div class="card-body" id="resultsContent">
                <!-- Generated test cases will appear here -->
            </div>
        </div>

        <!-- Loading Indicator -->
        <div class="card mt-4" id="loadingCard" style="display: none;">
            <div class="card-body text-center py-5">
                <div class="spinner-border text-primary mb-3" role="status">
                    <span class="visually-hidden">Đang tải...</span>
                </div>
                <h6>Đang phân tích tài liệu API và tạo Test Case...</h6>
                <small class="text-muted">Quá trình này có thể mất vài phút</small>
            </div>
        </div>
    </div>

    <div class="col-lg-4">
        <!-- RAG Status & Control -->
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-robot me-2"></i>Trạng thái hệ thống RAG</h5>
            </div>
            <div class="card-body">
                <div id="ragStatusContainer">
                    {% if rag_status %}
                    <div class="mb-3">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <span class="small">Đã khởi tạo:</span>
                            <span class="badge bg-{{ 'success' if rag_status.initialized else 'danger' }}">
                                {{ 'Có' if rag_status.initialized else 'Không' }}
                            </span>
                        </div>
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <span class="small">Đã embedding:</span>
                            <span class="badge bg-{{ 'success' if rag_status.embedded else 'warning' }}">
                                {{ 'Có' if rag_status.embedded else 'Chưa' }}
                            </span>
                        </div>
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <span class="small">Vector Store:</span>
                            <span class="badge bg-{{ 'success' if rag_status.vectorstore_ready else 'danger' }}">
                                {{ 'Sẵn sàng' if rag_status.vectorstore_ready else 'Chưa sẵn sàng' }}
                            </span>
                        </div>
                    </div>
                    {% endif %}
                    
                    {% if not rag_status.embedded %}
                    <div class="alert alert-warning py-2 mb-3">
                        <i class="fas fa-exclamation-triangle me-1"></i>
                        <small>Cần embedding dữ liệu để RAG hoạt động đúng cách.</small>
                    </div>
                    {% endif %}
                    
                    <div class="d-grid gap-2">
                        <button type="button" class="btn btn-primary" onclick="embedDocuments()" id="embedBtn">
                            <i class="fas fa-database me-1"></i>Embedding dữ liệu
                        </button>
                        <button type="button" class="btn btn-outline-secondary" onclick="refreshStatus()">
                            <i class="fas fa-refresh me-1"></i>Làm mới trạng thái
                        </button>
                        <button type="button" class="btn btn-outline-info" onclick="refreshAllCaches()">
                            <i class="fas fa-sync-alt me-1"></i>Làm mới cache
                        </button>
                        <div class="border-top pt-2 mt-2">
                            <button type="button" class="btn btn-outline-danger w-100" onclick="resetSystem()">
                                <i class="fas fa-trash-alt me-1"></i>Reset toàn bộ hệ thống
                            </button>
                            <small class="text-muted d-block mt-1 text-center">
                                <i class="fas fa-exclamation-triangle me-1"></i>Xóa tất cả Test Case & RAG data
                            </small>
                        </div>
                    </div>
                </div>
                
                <!-- Embedding Progress -->
                <div id="embeddingProgress" style="display: none;" class="mt-3">
                    <div class="progress mb-2">
                        <div class="progress-bar progress-bar-striped progress-bar-animated" 
                             role="progressbar" style="width: 0%" id="progressBar"></div>
                    </div>
                    <small class="text-muted" id="progressText">Đang khởi tạo...</small>
                </div>
            </div>
        </div>


        <!-- Suggestions -->
        {% if suggestions %}
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="card-title mb-0"><i class="fas fa-lightbulb"></i> Detected Scenarios</h5>
            </div>
            <div class="card-body">
                {% for suggestion in suggestions %}
                <div class="alert alert-{{ 'danger' if suggestion.priority == 'high' else 'warning' if suggestion.priority == 'medium' else 'info' }} py-2">
                    <strong>{{ suggestion.category.title() }}:</strong> {{ suggestion.description }}
                    <br><small>{{ suggestion.rationale }}</small>
                </div>
                {% endfor %}
            </div>
        </div>
        {% endif %}

        <!-- Business Flows -->
        {% if flows %}
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="card-title mb-0"><i class="fas fa-sitemap"></i> Business Flows</h5>
            </div>
            <div class="card-body">
                <div style="max-height: 300px; overflow-y: auto;">
                    {% for flow in flows %}
                    <div class="border-bottom py-2">
                        <strong>Step {{ flow.step }}:</strong> {{ flow.actor }}
                        <br><small class="text-muted">{{ flow.description[:100] }}{% if flow.description|length > 100 %}...{% endif %}</small>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
        {% endif %}

    </div>
</div>

<!-- Prompt Review Modal -->
<div class="modal fade" id="promptModal" tabindex="-1" aria-labelledby="promptModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="promptModalLabel">
                    <i class="fas fa-eye me-2"></i>Xem và chỉnh sửa Prompt
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-info">
                    <i class="fas fa-info-circle me-1"></i>
                    <strong>Hướng dẫn:</strong> Bạn có thể chỉnh sửa prompt để tùy chỉnh cách RAG tạo Test Case. 
                    Các biến <code>{context}</code> và <code>{question}</code> sẽ được thay thế tự động.
                </div>
                
                <div class="mb-3">
                    <label for="promptText" class="form-label">
                        <strong>Prompt Template:</strong>
                    </label>
                    <textarea class="form-control" id="promptText" rows="20" style="font-family: monospace; font-size: 12px;"></textarea>
                </div>
                
                <div class="row">
                    <div class="col-md-6">
                        <h6>Biến có sẵn:</h6>
                        <ul class="small">
                            <li><code>{context}</code> - Test Case tương tự từ database</li>
                            <li><code>{question}</code> - Tài liệu API đầu vào</li>
                        </ul>
                    </div>
                    <div class="col-md-6">
                        <h6>Mẹo tùy chỉnh:</h6>
                        <ul class="small">
                            <li>Thay đổi số lượng Test Case cần tạo</li>
                            <li>Điều chỉnh focus (security, performance, etc.)</li>
                            <li>Thêm yêu cầu đặc biệt cho dự án</li>
                        </ul>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline-secondary" onclick="resetPrompt()">
                    <i class="fas fa-undo me-1"></i>Khôi phục mặc định
                </button>
                <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times me-1"></i>Hủy
                </button>
                <button type="button" class="btn btn-primary" onclick="savePromptAndGenerate()">
                    <i class="fas fa-magic me-1"></i>Lưu và tạo Test Case
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Final Prompt Modal -->
<div class="modal fade" id="finalPromptModal" tabindex="-1" aria-labelledby="finalPromptModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="finalPromptModalLabel">
                    <i class="fas fa-eye me-2"></i>Prompt đã gửi tới LLM
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-info">
                    <i class="fas fa-info-circle me-1"></i>
                    <strong>Thông tin:</strong> Đây là prompt cuối cùng đã được gửi tới Google Gemini, 
                    bao gồm context từ RAG và tài liệu API của bạn.
                </div>
                
                <div class="mb-3">
                    <label class="form-label">
                        <strong>Context từ RAG (Test Case tương tự):</strong>
                    </label>
                    <textarea class="form-control" id="contextUsed" rows="8" readonly 
                              style="font-family: monospace; font-size: 11px; background-color: #f8f9fa;"></textarea>
                </div>
                
                <div class="mb-3">
                    <label class="form-label">
                        <strong>Prompt hoàn chỉnh đã gửi:</strong>
                    </label>
                    <textarea class="form-control" id="finalPromptContent" rows="15" readonly 
                              style="font-family: monospace; font-size: 11px; background-color: #f8f9fa;"></textarea>
                </div>
                
                <div class="row">
                    <div class="col-md-6">
                        <h6>Thống kê:</h6>
                        <ul class="small" id="promptStats">
                            <li>Độ dài prompt: <span id="promptLength">-</span> ký tự</li>
                            <li>Số Test Case context: <span id="contextCount">-</span></li>
                            <li>Loại prompt: <span id="promptType">-</span></li>
                        </ul>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline-secondary" onclick="copyFinalPrompt()">
                    <i class="fas fa-copy me-1"></i>Sao chép Prompt
                </button>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times me-1"></i>Đóng
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Prompt management is now handled entirely in the backend
let currentPromptType = 'default'; // Track which prompt type is being used

// Load active prompt info on page load
document.addEventListener('DOMContentLoaded', function() {
    loadActivePromptInfo();
    
    // Auto-refresh RAG status on page load to trigger auto-connection
    setTimeout(() => {
        refreshStatus();
    }, 1000);
});

function loadActivePromptInfo() {
    fetch('/api/prompts/active')
        .then(response => response.json())
        .then(data => {
            if (data.success && data.prompt) {
                const prompt = data.prompt;
                const promptName = prompt.name || 'Default Template';
                const promptType = prompt.is_system ? 'System' : 'Custom';
                
                document.getElementById('activePromptName').innerHTML = 
                    `<strong>${promptName}</strong> <span class="badge bg-${prompt.is_system ? 'primary' : 'success'}">${promptType}</span>`;
                
                currentPromptType = prompt.is_system ? 'default' : 'custom';
                updatePromptIndicator();
            } else {
                console.error('Failed to load active prompt:', data.error || 'No prompt data');
                document.getElementById('activePromptName').textContent = 'Default Template';
                currentPromptType = 'default';
                updatePromptIndicator();
            }
        })
        .catch(error => {
            console.error('Error loading active prompt info:', error);
            document.getElementById('activePromptName').textContent = 'Default Template';
            currentPromptType = 'default';
            updatePromptIndicator();
        });
}

function clearInput() {
    clearFiles();
}

function reviewPrompt() {
    const apiInput = document.getElementById('apiInput').value.trim();
    
    if (!apiInput) {
        alert('Vui lòng chọn file tài liệu trước khi xem prompt');
        return;
    }
    
    // Fetch current prompt from backend
    fetch('/api/get-current-prompt', {
        method: 'GET',
        headers: {
            'Content-Type': 'application/json',
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            document.getElementById('promptText').value = data.prompt;
            currentPromptType = data.prompt_type;
            
            // Show modal
            const modal = new bootstrap.Modal(document.getElementById('promptModal'));
            modal.show();
        } else {
            alert('Lỗi khi tải prompt: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Error fetching prompt:', error);
        alert('Lỗi kết nối khi tải prompt');
    });
}

function resetPrompt() {
    // Reset to default prompt on backend
    fetch('/api/reset-prompt', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            document.getElementById('promptText').value = data.prompt;
            currentPromptType = 'default';
            updatePromptIndicator();
        } else {
            alert('Lỗi khi reset prompt: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Error resetting prompt:', error);
        alert('Lỗi kết nối khi reset prompt');
    });
}

function savePromptAndGenerate() {
    // Save the edited prompt to backend
    const customPrompt = document.getElementById('promptText').value;
    
    fetch('/api/save-custom-prompt', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            custom_prompt: customPrompt
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            currentPromptType = 'custom';
            updatePromptIndicator();
            
            // Close modal
            const modal = bootstrap.Modal.getInstance(document.getElementById('promptModal'));
            modal.hide();
            
            // Generate test cases with custom prompt
            generateTestCases();
        } else {
            alert('Lỗi khi lưu prompt: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Error saving prompt:', error);
        alert('Lỗi kết nối khi lưu prompt');
    });
}

function resetToDefaultPrompt() {
    fetch('/api/reset-prompt', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            currentPromptType = 'default';
            updatePromptIndicator();
        } else {
            alert('Lỗi khi reset prompt: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Error resetting prompt:', error);
        alert('Lỗi kết nối khi reset prompt');
    });
}

function updatePromptIndicator() {
    const promptBtn = document.getElementById('promptBtn');
    
    if (currentPromptType === 'custom') {
        promptBtn.innerHTML = '<i class="fas fa-edit me-1"></i>Chỉnh sửa Prompt';
        promptBtn.classList.remove('btn-outline-primary');
        promptBtn.classList.add('btn-warning');
    } else {
        promptBtn.innerHTML = '<i class="fas fa-eye me-1"></i>Xem Prompt';
        promptBtn.classList.remove('btn-warning');
        promptBtn.classList.add('btn-outline-primary');
    }
}

// File handling functions
let mainDocuments = [];
let referenceDocuments = [];

function handleMainFileSelection() {
    const fileInput = document.getElementById('mainFileInput');
    const files = Array.from(fileInput.files);
    
    if (files.length === 0) {
        mainDocuments = [];
        document.getElementById('mainFilesList').innerHTML = '';
        updateCombinedContent();
        return;
    }
    
    // Show upload status
    document.getElementById('mainUploadStatus').style.display = 'block';
    
    // Process main files
    processFiles(files, 'main');
}

function handleRefFileSelection() {
    const fileInput = document.getElementById('refFileInput');
    const files = Array.from(fileInput.files);
    
    if (files.length === 0) {
        referenceDocuments = [];
        document.getElementById('refFilesList').innerHTML = '';
        updateCombinedContent();
        return;
    }
    
    // Show upload status
    document.getElementById('refUploadStatus').style.display = 'block';
    
    // Process reference files
    processFiles(files, 'reference');
}

function processFiles(files, docType) {
    const formData = new FormData();
    
    for (let i = 0; i < files.length; i++) {
        formData.append('files', files[i]);
    }
    formData.append('doc_type', docType);
    
    fetch('/upload-documents', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        // Hide upload status
        if (docType === 'main') {
            document.getElementById('mainUploadStatus').style.display = 'none';
        } else {
            document.getElementById('refUploadStatus').style.display = 'none';
        }
        
        if (data.success) {
            if (docType === 'main') {
                mainDocuments = data.files;
                displayFileList(data.files, 'mainFilesList', 'main');
            } else {
                referenceDocuments = data.files;
                displayFileList(data.files, 'refFilesList', 'reference');
            }
            updateCombinedContent();
        } else {
            alert('Error uploading files: ' + data.error);
        }
    })
    .catch(error => {
        // Hide upload status
        if (docType === 'main') {
            document.getElementById('mainUploadStatus').style.display = 'none';
        } else {
            document.getElementById('refUploadStatus').style.display = 'none';
        }
        alert('Error uploading files: ' + error);
    });
}

function displayFileList(files, containerId, docType) {
    const fileList = document.getElementById(containerId);
    if (!files || files.length === 0) {
        fileList.innerHTML = '';
        return;
    }
    
    const isMain = docType === 'main';
    const iconClass = isMain ? 'fas fa-star text-warning' : 'fas fa-book text-info';
    const badgeClass = isMain ? 'bg-warning' : 'bg-info';
    
    let html = `<div class="mt-2"><small class="text-muted">${isMain ? 'Tài liệu chính' : 'Tài liệu tham khảo'}:</small>`;
    
    files.forEach((file, index) => {
        html += `
            <div class="file-item d-flex justify-content-between align-items-center mb-2 p-2 border rounded">
                <div>
                    <i class="${iconClass} me-2"></i>
                    <strong>${file.name}</strong>
                    <small class="text-muted ms-2">(${file.size})</small>
                </div>
                <button type="button" class="btn btn-sm btn-outline-danger" onclick="removeFile('${docType}', ${index})">
                    <i class="fas fa-times"></i>
                </button>
            </div>
        `;
    });
    
    html += '</div>';
    fileList.innerHTML = html;
}

function formatFileSize(bytes) {
    if (bytes === 0) return '0 Bytes';
    const k = 1024;
    const sizes = ['Bytes', 'KB', 'MB', 'GB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
}

function removeFile(docType, index) {
    if (docType === 'main') {
        mainDocuments.splice(index, 1);
        displayFileList(mainDocuments, 'mainFilesList', 'main');
        if (mainDocuments.length === 0) {
            document.getElementById('mainFileInput').value = '';
        }
    } else {
        referenceDocuments.splice(index, 1);
        displayFileList(referenceDocuments, 'refFilesList', 'reference');
        if (referenceDocuments.length === 0) {
            document.getElementById('refFileInput').value = '';
        }
    }
    updateCombinedContent();
}

function clearFiles() {
    mainDocuments = [];
    referenceDocuments = [];
    document.getElementById('mainFileInput').value = '';
    document.getElementById('refFileInput').value = '';
    document.getElementById('mainFilesList').innerHTML = '';
    document.getElementById('refFilesList').innerHTML = '';
    document.getElementById('apiInput').value = '';
    document.getElementById('filePreviewArea').style.display = 'none';
}

function updateCombinedContent() {
    let combinedContent = '';
    
    // Add main documents section
    if (mainDocuments.length > 0) {
        combinedContent += '# MAIN DOCUMENTS\n';
        combinedContent += '# These are the primary documents you need to work on for test case generation\n\n';
        
        mainDocuments.forEach(doc => {
            combinedContent += `## ${doc.name}\n`;
            combinedContent += `${doc.content}\n\n`;
        });
    }
    
    // Add reference documents section
    if (referenceDocuments.length > 0) {
        combinedContent += '\n# REFERENCE DOCUMENTS\n';
        combinedContent += '# These are supporting documents for additional context if needed\n\n';
        
        referenceDocuments.forEach(doc => {
            combinedContent += `## ${doc.name}\n`;
            combinedContent += `${doc.content}\n\n`;
        });
    }
    
    document.getElementById('apiInput').value = combinedContent;
    
    // Show/hide file preview area
    if (mainDocuments.length > 0 || referenceDocuments.length > 0) {
        document.getElementById('filePreviewArea').style.display = 'block';
    } else {
        document.getElementById('filePreviewArea').style.display = 'none';
    }
}

// Legacy function for backward compatibility
function handleFileSelection() {
    // Redirect to main file selection for backward compatibility
    handleMainFileSelection();
}

// Removed old updateCombinedContent function - using the new two-file system version above

function previewContent() {
    const content = document.getElementById('apiInput').value;
    if (!content) {
        alert('Chưa có nội dung để xem');
        return;
    }
    
    // Create a modal to show content preview
    const modal = document.createElement('div');
    modal.className = 'modal fade';
    modal.innerHTML = `
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="fas fa-eye me-2"></i>Xem trước nội dung files
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <textarea class="form-control" rows="20" readonly style="font-family: monospace; font-size: 12px;">${content}</textarea>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
                </div>
            </div>
        </div>
    `;
    
    document.body.appendChild(modal);
    const bsModal = new bootstrap.Modal(modal);
    bsModal.show();
    
    // Remove modal from DOM when hidden
    modal.addEventListener('hidden.bs.modal', () => {
        document.body.removeChild(modal);
    });
}

// Global variables for two-step process
let currentPlan = null;
let generatedResults = {};

function startGeneration() {
    const apiInput = document.getElementById('apiInput').value.trim();
    
    if (!apiInput) {
        alert('Vui lòng nhập tài liệu API');
        return;
    }
    
    // Check which mode is selected
    const isTwoStep = document.getElementById('usePlanning').checked;
    
    if (isTwoStep) {
        startTwoStepGeneration(apiInput);
    } else {
        startSingleStepGeneration(apiInput);
    }
}

function startSingleStepGeneration(apiInput) {
    // Hide other sections
    document.getElementById('progressCard').style.display = 'none';
    document.getElementById('resultsCard').style.display = 'none';
    
    // Show loading
    document.getElementById('loadingCard').style.display = 'block';
    
    const requestData = 'api_input=' + encodeURIComponent(apiInput);
    
    fetch('/generate-test-cases', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
        },
        body: requestData
    })
    .then(response => response.json())
    .then(data => {
        document.getElementById('loadingCard').style.display = 'none';
        
        if (data.success) {
            displayResults(data.generated_cases, data);
        } else {
            alert('Lỗi: ' + data.error);
        }
    })
    .catch(error => {
        document.getElementById('loadingCard').style.display = 'none';
        alert('Lỗi khi tạo Test Case: ' + error);
    });
}

function startTwoStepGeneration(apiInput) {
    // Hide other sections
    document.getElementById('resultsCard').style.display = 'none';
    
    // Show progress
    document.getElementById('progressCard').style.display = 'block';
    document.getElementById('loadingCard').style.display = 'block';
    
    updateProgress('Đang phân tích tài liệu và lập kế hoạch...', 10);
    
    // Step 1: Create plan
    const requestData = 'api_input=' + encodeURIComponent(apiInput);
    
    fetch('/create-generation-plan', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
        },
        body: requestData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            currentPlan = data.plan;
            updateProgress('Kế hoạch đã tạo! Bắt đầu tạo test case...', 30);
            
            // Show plan summary
            showPlanSummary(data);
            
            // Start generating all calls
            generateAllCallsSequentially();
        } else {
            document.getElementById('loadingCard').style.display = 'none';
            alert('Lỗi khi tạo kế hoạch: ' + data.error);
        }
    })
    .catch(error => {
        document.getElementById('loadingCard').style.display = 'none';
        alert('Lỗi khi tạo kế hoạch: ' + error);
    });
}

function updateProgress(message, percentage) {
    const progressContent = document.getElementById('progressContent');
    if (progressContent) {
        progressContent.innerHTML = `
            <div class="mb-3">
                <div class="progress">
                    <div class="progress-bar progress-bar-striped progress-bar-animated" 
                         style="width: ${percentage}%"></div>
                </div>
                <small class="text-muted mt-2 d-block">${message}</small>
            </div>
        `;
    }
}

function showPlanSummary(data) {
    const plan = data.plan;
    const summary = data.plan_summary;
    
    const progressContent = document.getElementById('progressContent');
    if (progressContent) {
        progressContent.innerHTML += `
            <div class="row text-center mb-3">
                <div class="col-3">
                    <div class="h5 text-primary">${summary.total_calls}</div>
                    <small class="text-muted">Calls</small>
                </div>
                <div class="col-3">
                    <div class="h5 text-success">${summary.total_test_cases}</div>
                    <small class="text-muted">Test cases ước tính</small>
                </div>
                <div class="col-3">
                    <div class="h5 text-info">${summary.complexity}</div>
                    <small class="text-muted">Độ phức tạp</small>
                </div>
                <div class="col-3">
                    <div class="h5 text-warning">${plan.complexity_analysis?.total_endpoints || 'N/A'}</div>
                    <small class="text-muted">Endpoints</small>
                </div>
            </div>
            <div id="callProgress"></div>
        `;
    }
}

function generateAllCallsSequentially() {
    if (!currentPlan) return;
    
    const calls = currentPlan.generation_calls;
    let currentCallIndex = 0;
    generatedResults = {};
    
    function generateNextCall() {
        if (currentCallIndex >= calls.length) {
            // All calls completed
            combineAllResults();
            return;
        }
        
        const call = calls[currentCallIndex];
        const progress = 30 + (currentCallIndex / calls.length) * 60;
        
        updateProgress(`Đang tạo test case cho: ${call.focus_area}`, progress);
        updateCallProgress(calls, currentCallIndex);
        
        const requestData = {
            plan: currentPlan,
            call_id: call.call_id,
            custom_prompt: null
        };
        
        fetch('/generate-with-plan', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(requestData)
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                generatedResults[call.call_id] = {
                    count: data.generated_cases.length,
                    cases: data.generated_cases,
                    call_info: data.call_info
                };
                
                currentCallIndex++;
                setTimeout(generateNextCall, 1000); // Small delay between calls
            } else {
                alert(`Lỗi Call ${call.call_id}: ${data.error}`);
                currentCallIndex++;
                setTimeout(generateNextCall, 1000);
            }
        })
        .catch(error => {
            alert(`Lỗi Call ${call.call_id}: ${error}`);
            currentCallIndex++;
            setTimeout(generateNextCall, 1000);
        });
    }
    
    generateNextCall();
}

function updateCallProgress(calls, currentIndex) {
    const callProgressDiv = document.getElementById('callProgress');
    if (callProgressDiv) {
        let html = '<div class="row">';
        
        calls.forEach((call, index) => {
            let statusClass = 'text-muted';
            let icon = 'fas fa-clock';
            
            if (index < currentIndex) {
                statusClass = 'text-success';
                icon = 'fas fa-check';
            } else if (index === currentIndex) {
                statusClass = 'text-primary';
                icon = 'fas fa-spinner fa-spin';
            }
            
            html += `
                <div class="col-md-6 mb-2">
                    <small class="${statusClass}">
                        <i class="${icon} me-1"></i>
                        Call ${call.call_id}: ${call.focus_area}
                    </small>
                </div>
            `;
        });
        
        html += '</div>';
        callProgressDiv.innerHTML = html;
    }
}

function combineAllResults() {
    const allCases = [];
    
    Object.keys(generatedResults).forEach(callId => {
        const result = generatedResults[callId];
        allCases.push(...result.cases);
    });
    
    updateProgress('Hoàn thành! Đang hiển thị kết quả...', 100);
    
    setTimeout(() => {
        document.getElementById('loadingCard').style.display = 'none';
        document.getElementById('progressCard').style.display = 'none';
        
        if (allCases.length > 0) {
            const combinedData = {
                success: true,
                generated_cases: allCases,
                message: `Đã tạo ${allCases.length} test case từ ${Object.keys(generatedResults).length} calls`,
                two_step_mode: true
            };
            
            displayResults(allCases, combinedData);
        } else {
            alert('Không có test case nào được tạo');
        }
    }, 1000);
}

// Legacy function for backward compatibility
function generateTestCases() {
    startGeneration();
}

function displayResults(testCases, data = {}) {
    const resultsContent = document.getElementById('resultsContent');
    
    let html = `<div class="alert alert-success">
        <i class="fas fa-check-circle me-1"></i>Đã tạo thành công ${testCases.length} Test Case!
        ${data.used_custom_prompt ? '<br><small><i class="fas fa-edit me-1"></i>Sử dụng prompt tùy chỉnh</small>' : ''}
    </div>`;
    
    testCases.forEach((testCase, index) => {
        html += `
        <div class="card mb-3">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h6 class="mb-0"><i class="fas fa-vial me-1"></i>${testCase.id}</h6>
                <button class="btn btn-sm btn-outline-secondary" onclick="copyTestCase(${index})">
                    <i class="fas fa-copy me-1"></i>Sao chép
                </button>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-12 mb-3">
                        <div class="row">
                            <div class="col-md-4">
                                <p><strong>Mục đích:</strong> ${testCase.purpose}</p>
                            </div>
                            <div class="col-md-4">
                                <p><strong>Kịch bản:</strong> ${testCase.scenerio}</p>
                            </div>
                            <div class="col-md-4">
                                <p><strong>Dữ liệu test:</strong> <span class="badge bg-info">${testCase.test_data}</span></p>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="row">
                    <div class="col-md-6">
                        <h6>Các bước:</h6>
                        <ol class="small">
                            ${testCase.steps.map(step => `<li>${step}</li>`).join('')}
                        </ol>
                    </div>
                    <div class="col-md-6">
                        <h6>Kết quả mong đợi:</h6>
                        <ol class="small">
                            ${testCase.expected.map(exp => `<li>${exp}</li>`).join('')}
                        </ol>
                    </div>
                </div>
                
                ${testCase.note ? `<div class="row"><div class="col-12"><p><small class="text-muted"><i class="fas fa-sticky-note me-1"></i>${testCase.note}</small></p></div></div>` : ''}
                
                <div class="mt-2">
                    <button class="btn btn-sm btn-primary" onclick="addToTestCases(${index})">
                        <i class="fas fa-plus me-1"></i>Thêm vào danh sách
                    </button>
                </div>
            </div>
        </div>`;
    });
    
    resultsContent.innerHTML = html;
    document.getElementById('resultsCard').style.display = 'block';
    
    // Store results for export
    window.generatedTestCases = testCases;
    window.lastGenerationData = data;
}

function copyTestCase(index) {
    const testCase = window.generatedTestCases[index];
    const jsonString = JSON.stringify(testCase, null, 2);
    
    navigator.clipboard.writeText(jsonString).then(() => {
        // Show success feedback
        const btn = event.target.closest('button');
        const originalText = btn.innerHTML;
        btn.innerHTML = '<i class="fas fa-check me-1"></i>Đã sao chép!';
        btn.classList.add('btn-success');
        btn.classList.remove('btn-outline-secondary');
        
        setTimeout(() => {
            btn.innerHTML = originalText;
            btn.classList.remove('btn-success');
            btn.classList.add('btn-outline-secondary');
        }, 2000);
    });
}

function addToTestCases(index) {
    const testCase = window.generatedTestCases[index];
    
    // In a real implementation, this would make an API call to add the test case
    if (confirm(`Thêm Test Case "${testCase.id}" vào cơ sở dữ liệu?`)) {
        // Simulate adding to database
        alert('Test Case sẽ được thêm vào cơ sở dữ liệu trong phiên bản thực tế');
    }
}

function exportResults() {
    if (!window.generatedTestCases) {
        alert('Không có Test Case nào để xuất');
        return;
    }
    
    const jsonString = JSON.stringify(window.generatedTestCases, null, 2);
    const blob = new Blob([jsonString], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    
    const a = document.createElement('a');
    a.href = url;
    a.download = `generated_test_cases_${new Date().toISOString().slice(0, 10)}.json`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
}

function exportToExcel() {
    if (!window.generatedTestCases) {
        alert('Không có Test Case nào để xuất');
        return;
    }
    
    // Create Excel data with headers
    const headers = ['ID', 'Mục đích', 'Kịch bản', 'Dữ liệu test', 'Các bước', 'Kết quả mong đợi', 'Ghi chú'];
    const data = [headers];
    
    window.generatedTestCases.forEach(testCase => {
        const row = [
            testCase.id || '',
            testCase.purpose || '',
            testCase.scenerio || '',
            testCase.test_data || '',
            (testCase.steps || []).join('\n'),
            (testCase.expected || []).join('\n'),
            testCase.note || ''
        ];
        data.push(row);
    });
    
    // Convert to CSV format
    const csvContent = data.map(row => 
        row.map(field => `"${String(field).replace(/"/g, '""')}"`)
           .join(',')
    ).join('\n');
    
    // Add BOM for UTF-8 encoding
    const BOM = '\uFEFF';
    const blob = new Blob([BOM + csvContent], { type: 'text/csv;charset=utf-8;' });
    const url = URL.createObjectURL(blob);
    
    const a = document.createElement('a');
    a.href = url;
    a.download = `test_cases_${new Date().toISOString().slice(0, 10)}.csv`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
}

function showFinalPrompt() {
    if (!window.lastGenerationData || !window.lastGenerationData.final_prompt) {
        alert('Không có thông tin prompt. Vui lòng tạo Test Case trước.');
        return;
    }
    
    const data = window.lastGenerationData;
    
    // Populate modal content
    document.getElementById('contextUsed').value = data.context_used || 'Không có context';
    document.getElementById('finalPromptContent').value = data.final_prompt || 'Không có prompt';
    
    // Update statistics
    const promptLength = (data.final_prompt || '').length;
    const contextLines = (data.context_used || '').split('\n').length;
    const promptType = data.used_custom_prompt ? 'Tùy chỉnh' : 'Mặc định';
    
    document.getElementById('promptLength').textContent = promptLength.toLocaleString();
    document.getElementById('contextCount').textContent = Math.floor(contextLines / 10); // Rough estimate
    document.getElementById('promptType').textContent = promptType;
    
    // Show modal
    const modal = new bootstrap.Modal(document.getElementById('finalPromptModal'));
    modal.show();
}

function copyFinalPrompt() {
    const promptContent = document.getElementById('finalPromptContent').value;
    
    if (!promptContent) {
        alert('Không có prompt để sao chép');
        return;
    }
    
    navigator.clipboard.writeText(promptContent).then(() => {
        // Show success feedback
        const btn = event.target.closest('button');
        const originalText = btn.innerHTML;
        btn.innerHTML = '<i class="fas fa-check me-1"></i>Đã sao chép!';
        btn.classList.add('btn-success');
        btn.classList.remove('btn-outline-secondary');
        
        setTimeout(() => {
            btn.innerHTML = originalText;
            btn.classList.remove('btn-success');
            btn.classList.add('btn-outline-secondary');
        }, 2000);
    }).catch(() => {
        alert('Không thể sao chép. Vui lòng chọn và copy thủ công.');
    });
}

function clearInput() {
    document.getElementById('apiInput').value = '';
    document.getElementById('resultsCard').style.display = 'none';
    document.getElementById('loadingCard').style.display = 'none';
}

function loadSampleAPI() {
    document.getElementById('apiInput').value = `# Payment API Documentation

## Overview
This API handles automatic payment processing for outstanding loans when customers deposit money into their wallets.

## Endpoints

### POST /api/v1/payment/auto
Automatically deduct outstanding loan amounts when customer deposits money.

**Request:**
- customer_id: string (required)
- amount: number (required) 
- wallet_id: string (required)

**Response:**
- status: success/error
- transaction_id: string
- deducted_amount: number

## Business Flow
1. Customer deposits money into wallet
2. System checks for outstanding loans
3. If loans exist, automatically deduct amounts
4. Update loan status and wallet balance
5. Send notifications

## Error Scenarios
- Insufficient balance
- API timeout (30s)
- Lender service unavailable
- Database transaction failure`;
}

function loadUserAPI() {
    document.getElementById('apiInput').value = `# User Management API

## Overview
Manages user registration, authentication, and profile updates.

## Endpoints

### POST /api/v1/users/register
Register a new user account.

### PUT /api/v1/users/profile
Update user profile information.

### DELETE /api/v1/users/{id}
Deactivate user account.

## Validation Rules
- Email must be unique
- Password minimum 8 characters
- Phone number format validation

## Error Handling
- Duplicate email: 409 Conflict
- Invalid data: 400 Bad Request
- User not found: 404 Not Found`;
}

function loadOrderAPI() {
    document.getElementById('apiInput').value = `# Order Processing API

## Overview
Handles order creation, payment processing, and fulfillment.

## Endpoints

### POST /api/v1/orders
Create a new order.

### PUT /api/v1/orders/{id}/status
Update order status.

### GET /api/v1/orders/{id}/tracking
Get order tracking information.

## Order States
- PENDING -> CONFIRMED -> PROCESSING -> SHIPPED -> DELIVERED
- PENDING -> CANCELLED

## Integration Points
- Payment gateway
- Inventory system
- Shipping providers
- Notification service`;
}

function embedDocuments() {
    const embedBtn = document.getElementById('embedBtn');
    const progressContainer = document.getElementById('embeddingProgress');
    const progressBar = document.getElementById('progressBar');
    const progressText = document.getElementById('progressText');
    
    // Disable button and show progress
    embedBtn.disabled = true;
    embedBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Đang embedding...';
    progressContainer.style.display = 'block';
    progressBar.style.width = '10%';
    progressText.textContent = 'Bắt đầu quá trình embedding...';
    
    fetch('/embed-documents', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Simulate progress completion
            progressBar.style.width = '100%';
            progressText.textContent = data.message || 'Embedding hoàn thành thành công!';
            
            setTimeout(() => {
                progressContainer.style.display = 'none';
                embedBtn.disabled = false;
                embedBtn.innerHTML = '<i class="fas fa-database me-1"></i>Embedding dữ liệu';
                
                // Refresh status
                refreshStatus();
                
                // Show success message
                alert('Embedding dữ liệu thành công! Bây giờ bạn có thể sử dụng RAG generator.');
            }, 2000);
        } else {
            progressContainer.style.display = 'none';
            embedBtn.disabled = false;
            embedBtn.innerHTML = '<i class="fas fa-database me-1"></i>Embedding dữ liệu';
            alert('Lỗi khi embedding dữ liệu: ' + data.error);
        }
    })
    .catch(error => {
        progressContainer.style.display = 'none';
        embedBtn.disabled = false;
        embedBtn.innerHTML = '<i class="fas fa-database me-1"></i>Embedding dữ liệu';
        alert('Lỗi khi embedding dữ liệu: ' + error);
    });
}

function refreshStatus() {
    fetch('/rag-status')
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            updateStatusDisplay(data.status);
            
            // Auto-connect if not initialized
            if (!data.status.initialized) {
                console.log('RAG not connected, attempting auto-connection...');
                connectToRAG();
            }
        } else {
            console.error('Error getting RAG status:', data.error);
        }
    })
    .catch(error => {
        console.error('Error getting RAG status:', error);
    });
}

function connectToRAG() {
    // Show connecting status
    const container = document.getElementById('ragStatusContainer');
    if (container) {
        container.innerHTML = `
            <div class="alert alert-info">
                <i class="fas fa-spinner fa-spin me-2"></i>
                <strong>Đang kết nối RAG...</strong>
                <p class="mb-0 small">Hệ thống đang khởi tạo kết nối với RAG service...</p>
            </div>
        `;
    }
    
    fetch('/api/connect-rag', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            console.log('RAG connected successfully');
            updateStatusDisplay(data.status);
            
            // Show success message briefly
            if (container) {
                const successAlert = document.createElement('div');
                successAlert.className = 'alert alert-success alert-dismissible fade show';
                successAlert.innerHTML = `
                    <i class="fas fa-check-circle me-2"></i>
                    <strong>Kết nối thành công!</strong> RAG service đã sẵn sàng.
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                `;
                container.insertBefore(successAlert, container.firstChild);
                
                // Auto-dismiss after 3 seconds
                setTimeout(() => {
                    if (successAlert.parentNode) {
                        successAlert.remove();
                    }
                }, 3000);
            }
        } else {
            console.error('Failed to connect RAG:', data.error);
            updateStatusDisplay({
                initialized: false,
                embedded: false,
                client_connected: false,
                vectorstore_ready: false,
                retriever_ready: false,
                workflow_ready: false
            });
            
            // Show error message
            if (container) {
                const errorAlert = document.createElement('div');
                errorAlert.className = 'alert alert-danger alert-dismissible fade show';
                errorAlert.innerHTML = `
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    <strong>Kết nối thất bại!</strong> ${data.error}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                `;
                container.insertBefore(errorAlert, container.firstChild);
            }
        }
    })
    .catch(error => {
        console.error('Error connecting to RAG:', error);
        updateStatusDisplay({
            initialized: false,
            embedded: false,
            client_connected: false,
            vectorstore_ready: false,
            retriever_ready: false,
            workflow_ready: false
        });
    });
}

function updateStatusDisplay(status) {
    const container = document.getElementById('ragStatusContainer');
    
    const statusHtml = `
        <div class="mb-3">
            <div class="d-flex justify-content-between align-items-center mb-2">
                <span class="small">Đã khởi tạo:</span>
                <span class="badge bg-${status.initialized ? 'success' : 'danger'}">
                    ${status.initialized ? 'Có' : 'Không'}
                </span>
            </div>
            <div class="d-flex justify-content-between align-items-center mb-2">
                <span class="small">Đã embedding:</span>
                <span class="badge bg-${status.embedded ? 'success' : 'warning'}">
                    ${status.embedded ? 'Có' : 'Chưa'}
                </span>
            </div>
            <div class="d-flex justify-content-between align-items-center mb-2">
                <span class="small">Vector Store:</span>
                <span class="badge bg-${status.vectorstore_ready ? 'success' : 'danger'}">
                    ${status.vectorstore_ready ? 'Sẵn sàng' : 'Chưa sẵn sàng'}
                </span>
            </div>
        </div>
        
        ${!status.initialized ? `
        <div class="alert alert-warning py-2 mb-3">
            <i class="fas fa-exclamation-triangle me-1"></i>
            <small>RAG chưa được kết nối. Nhấn "Kết nối RAG" để khởi tạo.</small>
        </div>
        ` : !status.embedded ? `
        <div class="alert alert-warning py-2 mb-3">
            <i class="fas fa-exclamation-triangle me-1"></i>
            <small>Cần embedding dữ liệu để RAG hoạt động đúng cách.</small>
        </div>
        ` : ''}
        
        <div class="d-grid gap-2">
            ${!status.initialized ? `
            <button type="button" class="btn btn-success" onclick="connectToRAG()" id="connectBtn">
                <i class="fas fa-plug me-1"></i>Kết nối RAG
            </button>
            ` : ''}
            <button type="button" class="btn btn-primary" onclick="embedDocuments()" id="embedBtn" ${!status.initialized ? 'disabled' : ''}>
                <i class="fas fa-database me-1"></i>Embedding dữ liệu
            </button>
            <button type="button" class="btn btn-outline-secondary" onclick="refreshStatus()">
                <i class="fas fa-refresh me-1"></i>Làm mới trạng thái
            </button>
        </div>
    `;
    
    // Update only the status part, preserve the progress container
    const progressContainer = document.getElementById('embeddingProgress');
    container.innerHTML = statusHtml;
    container.appendChild(progressContainer);
}

// Async loading improvements
document.addEventListener('DOMContentLoaded', function() {
    // Load non-critical components asynchronously
    setTimeout(() => {
        loadBusinessFlowsAsync();
        loadSampleTemplatesAsync();
    }, 100);
});

function loadBusinessFlowsAsync() {
    // Load business flows asynchronously if not already loaded
    const flowsContainer = document.querySelector('.card-body .border-bottom');
    if (!flowsContainer) {
        fetch('/api/business-flows')
            .then(response => response.json())
            .then(data => {
                if (data.success && data.flows.length > 0) {
                    updateFlowsDisplay(data.flows);
                }
            })
            .catch(error => console.log('Async flows loading failed:', error));
    }
}

function loadSampleTemplatesAsync() {
    // Pre-load sample templates
    const sampleButtons = document.querySelectorAll('[onclick*="loadSample"]');
    sampleButtons.forEach(button => {
        button.addEventListener('mouseenter', function() {
            // Pre-load content on hover for better UX
            const methodName = this.getAttribute('onclick').match(/load(\w+)API/);
            if (methodName && methodName[1]) {
                // Could implement pre-loading here
            }
        });
    });
}

function updateFlowsDisplay(flows) {
    const container = document.querySelector('.card-body');
    if (container && flows.length > 0) {
        let html = '';
        flows.slice(0, 10).forEach(flow => {
            html += `
            <div class="border-bottom py-2">
                <strong>Step ${flow.step}:</strong> ${flow.actor}
                <br><small class="text-muted">${flow.description ? flow.description.substring(0, 100) + '...' : ''}</small>
            </div>`;
        });
        container.innerHTML = '<div style="max-height: 300px; overflow-y: auto;">" + html + "</div>';
    }
}

// Improved loading indicators
function showLoadingState(message = 'Đang xử lý...') {
    const loadingCard = document.getElementById('loadingCard');
    const loadingText = loadingCard.querySelector('h6');
    loadingText.textContent = message;
    loadingCard.style.display = 'block';
}

function hideLoadingState() {
    document.getElementById('loadingCard').style.display = 'none';
}

// Cache refresh functionality
function refreshAllCaches() {
    fetch('/api/invalidate-cache', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({})
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Refresh the page data
            location.reload();
        }
    })
    .catch(error => console.error('Cache refresh failed:', error));
}

// Reset system functionality
function resetSystem() {
    if (!confirm('⚠️ CẢNH BÁO: Bạn có chắc chắn muốn reset toàn bộ hệ thống?\n\nViệc này sẽ:\n• Xóa tất cả Test Case trong database\n• Xóa tất cả dữ liệu RAG đã embedding\n• Reset vector store về trạng thái ban đầu\n\nHành động này KHÔNG THỂ HOÀN TÁC!')) {
        return;
    }
    
    // Double confirmation for safety
    if (!confirm('🔴 XÁC NHẬN LẦN CUỐI:\n\nBạn thực sự muốn XÓA TẤT CẢ dữ liệu?\nGõ "XÁC NHẬN" để tiếp tục.')) {
        return;
    }
    
    const userConfirmation = prompt('Để xác nhận, vui lòng gõ chính xác: XÁC NHẬN');
    if (userConfirmation !== 'XÁC NHẬN') {
        alert('Đã hủy thao tác reset.');
        return;
    }
    
    // Show loading state
    const resetBtn = event.target.closest('button');
    const originalText = resetBtn.innerHTML;
    resetBtn.disabled = true;
    resetBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Đang reset...';
    
    // Call reset API
    fetch('/reset-system', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            confirm: true,
            timestamp: new Date().toISOString()
        })
    })
    .then(response => response.json())
    .then(data => {
        resetBtn.disabled = false;
        resetBtn.innerHTML = originalText;
        
        if (data.success) {
            alert('✅ Reset thành công!\n\n' + data.message);
            
            // Clear UI elements
            clearInput();
            document.getElementById('resultsCard').style.display = 'none';
            document.getElementById('loadingCard').style.display = 'none';
            
            // Reset prompt to default
            currentPromptType = 'default';
            updatePromptIndicator();
            
            // Refresh status
            refreshStatus();
            
            // Optionally reload page for complete reset
            setTimeout(() => {
                if (confirm('Tải lại trang để hoàn tất reset?')) {
                    location.reload();
                }
            }, 2000);
        } else {
            alert('❌ Lỗi khi reset hệ thống:\n' + data.error);
        }
    })
    .catch(error => {
        resetBtn.disabled = false;
        resetBtn.innerHTML = originalText;
        alert('❌ Lỗi kết nối khi reset hệ thống:\n' + error);
        console.error('Reset system error:', error);
    });
}
</script>
{% endblock %}