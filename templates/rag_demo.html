{% extends "base.html" %}

{% block title %}RAG Generator - T·∫°o Test Case{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <div>
        <h2><i class="fas fa-magic me-2"></i>RAG Generator</h2>
        <p class="text-muted mb-0">T·∫°o Test Case t·ª± ƒë·ªông t·ª´ t√†i li·ªáu API</p>
    </div>
    <button type="button" class="btn btn-outline-secondary" onclick="loadSampleAPI()">
        <i class="fas fa-file-alt me-1"></i>T·∫£i m·∫´u API
    </button>
</div>

<div class="row">
    <div class="col-lg-8">
        <!-- API Input -->
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-code me-2"></i>Nh·∫≠p t√†i li·ªáu API</h5>
            </div>
            <div class="card-body">
                <form id="ragForm">
                    <div class="mb-3">
                        <label for="apiInput" class="form-label">D√°n t√†i li·ªáu API v√†o ƒë√¢y:</label>
                        <textarea class="form-control" id="apiInput" name="api_input" rows="12" 
                                  placeholder="D√°n t√†i li·ªáu API (ƒë·ªãnh d·∫°ng Markdown) v√†o ƒë√¢y...">{{ api_doc if api_doc else '' }}</textarea>
                        <div class="form-text text-muted">
                            <i class="fas fa-info-circle me-1"></i>
                            H·ªá th·ªëng RAG s·∫Ω ph√¢n t√≠ch t√†i li·ªáu n√†y v√† t·∫°o Test Case d·ª±a tr√™n c√°c m·∫´u t∆∞∆°ng t·ª± trong c∆° s·ªü d·ªØ li·ªáu.
                        </div>
                    </div>
                    
                    <!-- Active Prompt Indicator -->
                    <div id="activePromptIndicator" class="alert alert-info py-2 mb-3">
                        <i class="fas fa-info-circle me-1"></i>
                        <small><strong>Prompt ƒëang s·ª≠ d·ª•ng:</strong> <span id="activePromptName">ƒêang t·∫£i...</span> | 
                        <a href="{{ url_for('prompt_manager') }}" class="alert-link">Qu·∫£n l√Ω Prompt</a></small>
                    </div>
                    
                    <div class="d-flex gap-2 justify-content-end">
                        <button type="button" class="btn btn-outline-secondary" onclick="clearInput()">
                            <i class="fas fa-eraser me-1"></i>X√≥a
                        </button>
                        <button type="button" class="btn btn-outline-primary" onclick="reviewPrompt()" id="promptBtn">
                            <i class="fas fa-eye me-1"></i>Xem Prompt
                        </button>
                        <button type="button" class="btn btn-primary" onclick="generateTestCases()">
                            <i class="fas fa-magic me-1"></i>T·∫°o Test Case
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Generated Results -->
        <div class="card mt-4" id="resultsCard" style="display: none;">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0"><i class="fas fa-list-check me-2"></i>Test Case ƒë√£ t·∫°o</h5>
                <div class="btn-group">
                    <button type="button" class="btn btn-sm btn-outline-info" onclick="showFinalPrompt()">
                        <i class="fas fa-eye me-1"></i>Xem Prompt ƒë√£ g·ª≠i
                    </button>
                    <button type="button" class="btn btn-sm btn-outline-secondary" onclick="exportResults()">
                        <i class="fas fa-download me-1"></i>Xu·∫•t file
                    </button>
                </div>
            </div>
            <div class="card-body" id="resultsContent">
                <!-- Generated test cases will appear here -->
            </div>
        </div>

        <!-- Loading Indicator -->
        <div class="card mt-4" id="loadingCard" style="display: none;">
            <div class="card-body text-center py-5">
                <div class="spinner-border text-primary mb-3" role="status">
                    <span class="visually-hidden">ƒêang t·∫£i...</span>
                </div>
                <h6>ƒêang ph√¢n t√≠ch t√†i li·ªáu API v√† t·∫°o Test Case...</h6>
                <small class="text-muted">Qu√° tr√¨nh n√†y c√≥ th·ªÉ m·∫•t v√†i ph√∫t</small>
            </div>
        </div>
    </div>

    <div class="col-lg-4">
        <!-- RAG Status & Control -->
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-robot me-2"></i>Tr·∫°ng th√°i h·ªá th·ªëng RAG</h5>
            </div>
            <div class="card-body">
                <div id="ragStatusContainer">
                    {% if rag_status %}
                    <div class="mb-3">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <span class="small">ƒê√£ kh·ªüi t·∫°o:</span>
                            <span class="badge bg-{{ 'success' if rag_status.initialized else 'danger' }}">
                                {{ 'C√≥' if rag_status.initialized else 'Kh√¥ng' }}
                            </span>
                        </div>
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <span class="small">ƒê√£ embedding:</span>
                            <span class="badge bg-{{ 'success' if rag_status.embedded else 'warning' }}">
                                {{ 'C√≥' if rag_status.embedded else 'Ch∆∞a' }}
                            </span>
                        </div>
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <span class="small">Vector Store:</span>
                            <span class="badge bg-{{ 'success' if rag_status.vectorstore_ready else 'danger' }}">
                                {{ 'S·∫µn s√†ng' if rag_status.vectorstore_ready else 'Ch∆∞a s·∫µn s√†ng' }}
                            </span>
                        </div>
                    </div>
                    {% endif %}
                    
                    {% if not rag_status.embedded %}
                    <div class="alert alert-warning py-2 mb-3">
                        <i class="fas fa-exclamation-triangle me-1"></i>
                        <small>C·∫ßn embedding d·ªØ li·ªáu ƒë·ªÉ RAG ho·∫°t ƒë·ªông ƒë√∫ng c√°ch.</small>
                    </div>
                    {% endif %}
                    
                    <div class="d-grid gap-2">
                        <button type="button" class="btn btn-primary" onclick="embedDocuments()" id="embedBtn">
                            <i class="fas fa-database me-1"></i>Embedding d·ªØ li·ªáu
                        </button>
                        <button type="button" class="btn btn-outline-secondary" onclick="refreshStatus()">
                            <i class="fas fa-refresh me-1"></i>L√†m m·ªõi tr·∫°ng th√°i
                        </button>
                        <button type="button" class="btn btn-outline-info" onclick="refreshAllCaches()">
                            <i class="fas fa-sync-alt me-1"></i>L√†m m·ªõi cache
                        </button>
                        <div class="border-top pt-2 mt-2">
                            <button type="button" class="btn btn-outline-danger w-100" onclick="resetSystem()">
                                <i class="fas fa-trash-alt me-1"></i>Reset to√†n b·ªô h·ªá th·ªëng
                            </button>
                            <small class="text-muted d-block mt-1 text-center">
                                <i class="fas fa-exclamation-triangle me-1"></i>X√≥a t·∫•t c·∫£ Test Case & RAG data
                            </small>
                        </div>
                    </div>
                </div>
                
                <!-- Embedding Progress -->
                <div id="embeddingProgress" style="display: none;" class="mt-3">
                    <div class="progress mb-2">
                        <div class="progress-bar progress-bar-striped progress-bar-animated" 
                             role="progressbar" style="width: 0%" id="progressBar"></div>
                    </div>
                    <small class="text-muted" id="progressText">ƒêang kh·ªüi t·∫°o...</small>
                </div>
            </div>
        </div>


        <!-- Suggestions -->
        {% if suggestions %}
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="card-title mb-0"><i class="fas fa-lightbulb"></i> Detected Scenarios</h5>
            </div>
            <div class="card-body">
                {% for suggestion in suggestions %}
                <div class="alert alert-{{ 'danger' if suggestion.priority == 'high' else 'warning' if suggestion.priority == 'medium' else 'info' }} py-2">
                    <strong>{{ suggestion.category.title() }}:</strong> {{ suggestion.description }}
                    <br><small>{{ suggestion.rationale }}</small>
                </div>
                {% endfor %}
            </div>
        </div>
        {% endif %}

        <!-- Business Flows -->
        {% if flows %}
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="card-title mb-0"><i class="fas fa-sitemap"></i> Business Flows</h5>
            </div>
            <div class="card-body">
                <div style="max-height: 300px; overflow-y: auto;">
                    {% for flow in flows %}
                    <div class="border-bottom py-2">
                        <strong>Step {{ flow.step }}:</strong> {{ flow.actor }}
                        <br><small class="text-muted">{{ flow.description[:100] }}{% if flow.description|length > 100 %}...{% endif %}</small>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
        {% endif %}

    </div>
</div>

<!-- Prompt Review Modal -->
<div class="modal fade" id="promptModal" tabindex="-1" aria-labelledby="promptModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="promptModalLabel">
                    <i class="fas fa-eye me-2"></i>Xem v√† ch·ªânh s·ª≠a Prompt
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-info">
                    <i class="fas fa-info-circle me-1"></i>
                    <strong>H∆∞·ªõng d·∫´n:</strong> B·∫°n c√≥ th·ªÉ ch·ªânh s·ª≠a prompt ƒë·ªÉ t√πy ch·ªânh c√°ch RAG t·∫°o Test Case. 
                    C√°c bi·∫øn <code>{context}</code> v√† <code>{question}</code> s·∫Ω ƒë∆∞·ª£c thay th·∫ø t·ª± ƒë·ªông.
                </div>
                
                <div class="mb-3">
                    <label for="promptText" class="form-label">
                        <strong>Prompt Template:</strong>
                    </label>
                    <textarea class="form-control" id="promptText" rows="20" style="font-family: monospace; font-size: 12px;"></textarea>
                </div>
                
                <div class="row">
                    <div class="col-md-6">
                        <h6>Bi·∫øn c√≥ s·∫µn:</h6>
                        <ul class="small">
                            <li><code>{context}</code> - Test Case t∆∞∆°ng t·ª± t·ª´ database</li>
                            <li><code>{question}</code> - T√†i li·ªáu API ƒë·∫ßu v√†o</li>
                        </ul>
                    </div>
                    <div class="col-md-6">
                        <h6>M·∫πo t√πy ch·ªânh:</h6>
                        <ul class="small">
                            <li>Thay ƒë·ªïi s·ªë l∆∞·ª£ng Test Case c·∫ßn t·∫°o</li>
                            <li>ƒêi·ªÅu ch·ªânh focus (security, performance, etc.)</li>
                            <li>Th√™m y√™u c·∫ßu ƒë·∫∑c bi·ªát cho d·ª± √°n</li>
                        </ul>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline-secondary" onclick="resetPrompt()">
                    <i class="fas fa-undo me-1"></i>Kh√¥i ph·ª•c m·∫∑c ƒë·ªãnh
                </button>
                <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times me-1"></i>H·ªßy
                </button>
                <button type="button" class="btn btn-primary" onclick="savePromptAndGenerate()">
                    <i class="fas fa-magic me-1"></i>L∆∞u v√† t·∫°o Test Case
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Final Prompt Modal -->
<div class="modal fade" id="finalPromptModal" tabindex="-1" aria-labelledby="finalPromptModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="finalPromptModalLabel">
                    <i class="fas fa-eye me-2"></i>Prompt ƒë√£ g·ª≠i t·ªõi LLM
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-info">
                    <i class="fas fa-info-circle me-1"></i>
                    <strong>Th√¥ng tin:</strong> ƒê√¢y l√† prompt cu·ªëi c√πng ƒë√£ ƒë∆∞·ª£c g·ª≠i t·ªõi Google Gemini, 
                    bao g·ªìm context t·ª´ RAG v√† t√†i li·ªáu API c·ªßa b·∫°n.
                </div>
                
                <div class="mb-3">
                    <label class="form-label">
                        <strong>Context t·ª´ RAG (Test Case t∆∞∆°ng t·ª±):</strong>
                    </label>
                    <textarea class="form-control" id="contextUsed" rows="8" readonly 
                              style="font-family: monospace; font-size: 11px; background-color: #f8f9fa;"></textarea>
                </div>
                
                <div class="mb-3">
                    <label class="form-label">
                        <strong>Prompt ho√†n ch·ªânh ƒë√£ g·ª≠i:</strong>
                    </label>
                    <textarea class="form-control" id="finalPromptContent" rows="15" readonly 
                              style="font-family: monospace; font-size: 11px; background-color: #f8f9fa;"></textarea>
                </div>
                
                <div class="row">
                    <div class="col-md-6">
                        <h6>Th·ªëng k√™:</h6>
                        <ul class="small" id="promptStats">
                            <li>ƒê·ªô d√†i prompt: <span id="promptLength">-</span> k√Ω t·ª±</li>
                            <li>S·ªë Test Case context: <span id="contextCount">-</span></li>
                            <li>Lo·∫°i prompt: <span id="promptType">-</span></li>
                        </ul>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline-secondary" onclick="copyFinalPrompt()">
                    <i class="fas fa-copy me-1"></i>Sao ch√©p Prompt
                </button>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times me-1"></i>ƒê√≥ng
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Prompt management is now handled entirely in the backend
let currentPromptType = 'default'; // Track which prompt type is being used

// Load active prompt info on page load
document.addEventListener('DOMContentLoaded', function() {
    loadActivePromptInfo();
});

function loadActivePromptInfo() {
    fetch('/api/prompts/active')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const prompt = data.prompt;
                const promptName = prompt.name;
                const promptType = prompt.is_system ? 'System' : 'Custom';
                
                document.getElementById('activePromptName').innerHTML = 
                    `<strong>${promptName}</strong> <span class="badge bg-${prompt.is_system ? 'primary' : 'success'}">${promptType}</span>`;
                
                currentPromptType = prompt.is_system ? 'default' : 'custom';
                updatePromptIndicator();
            } else {
                document.getElementById('activePromptName').textContent = 'L·ªói t·∫£i th√¥ng tin prompt';
            }
        })
        .catch(error => {
            console.error('Error loading active prompt info:', error);
            document.getElementById('activePromptName').textContent = 'L·ªói k·∫øt n·ªëi';
        });
}

function reviewPrompt() {
    const apiInput = document.getElementById('apiInput').value.trim();
    
    if (!apiInput) {
        alert('Vui l√≤ng nh·∫≠p t√†i li·ªáu API tr∆∞·ªõc khi xem prompt');
        return;
    }
    
    // Fetch current prompt from backend
    fetch('/api/get-current-prompt', {
        method: 'GET',
        headers: {
            'Content-Type': 'application/json',
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            document.getElementById('promptText').value = data.prompt;
            currentPromptType = data.prompt_type;
            
            // Show modal
            const modal = new bootstrap.Modal(document.getElementById('promptModal'));
            modal.show();
        } else {
            alert('L·ªói khi t·∫£i prompt: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Error fetching prompt:', error);
        alert('L·ªói k·∫øt n·ªëi khi t·∫£i prompt');
    });
}

function resetPrompt() {
    // Reset to default prompt on backend
    fetch('/api/reset-prompt', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            document.getElementById('promptText').value = data.prompt;
            currentPromptType = 'default';
            updatePromptIndicator();
        } else {
            alert('L·ªói khi reset prompt: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Error resetting prompt:', error);
        alert('L·ªói k·∫øt n·ªëi khi reset prompt');
    });
}

function savePromptAndGenerate() {
    // Save the edited prompt to backend
    const customPrompt = document.getElementById('promptText').value;
    
    fetch('/api/save-custom-prompt', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            custom_prompt: customPrompt
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            currentPromptType = 'custom';
            updatePromptIndicator();
            
            // Close modal
            const modal = bootstrap.Modal.getInstance(document.getElementById('promptModal'));
            modal.hide();
            
            // Generate test cases with custom prompt
            generateTestCases();
        } else {
            alert('L·ªói khi l∆∞u prompt: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Error saving prompt:', error);
        alert('L·ªói k·∫øt n·ªëi khi l∆∞u prompt');
    });
}

function resetToDefaultPrompt() {
    fetch('/api/reset-prompt', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            currentPromptType = 'default';
            updatePromptIndicator();
        } else {
            alert('L·ªói khi reset prompt: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Error resetting prompt:', error);
        alert('L·ªói k·∫øt n·ªëi khi reset prompt');
    });
}

function updatePromptIndicator() {
    const promptBtn = document.getElementById('promptBtn');
    
    if (currentPromptType === 'custom') {
        promptBtn.innerHTML = '<i class="fas fa-edit me-1"></i>Ch·ªânh s·ª≠a Prompt';
        promptBtn.classList.remove('btn-outline-primary');
        promptBtn.classList.add('btn-warning');
    } else {
        promptBtn.innerHTML = '<i class="fas fa-eye me-1"></i>Xem Prompt';
        promptBtn.classList.remove('btn-warning');
        promptBtn.classList.add('btn-outline-primary');
    }
}

function generateTestCases() {
    const apiInput = document.getElementById('apiInput').value.trim();
    
    if (!apiInput) {
        alert('Vui l√≤ng nh·∫≠p t√†i li·ªáu API');
        return;
    }
    
    // Show loading
    document.getElementById('loadingCard').style.display = 'block';
    document.getElementById('resultsCard').style.display = 'none';
    
    // Prepare request data - backend will handle prompt selection
    let requestData = 'api_input=' + encodeURIComponent(apiInput);
    
    // API call
    fetch('/generate-test-cases', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
        },
        body: requestData
    })
    .then(response => response.json())
    .then(data => {
        document.getElementById('loadingCard').style.display = 'none';
        
        if (data.success) {
            displayResults(data.generated_cases, data);
        } else {
            alert('L·ªói: ' + data.error);
        }
    })
    .catch(error => {
        document.getElementById('loadingCard').style.display = 'none';
        alert('L·ªói khi t·∫°o Test Case: ' + error);
    });
}

function displayResults(testCases, data = {}) {
    const resultsContent = document.getElementById('resultsContent');
    
    let html = `<div class="alert alert-success">
        <i class="fas fa-check-circle me-1"></i>ƒê√£ t·∫°o th√†nh c√¥ng ${testCases.length} Test Case!
        ${data.used_custom_prompt ? '<br><small><i class="fas fa-edit me-1"></i>S·ª≠ d·ª•ng prompt t√πy ch·ªânh</small>' : ''}
    </div>`;
    
    testCases.forEach((testCase, index) => {
        html += `
        <div class="card mb-3">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h6 class="mb-0"><i class="fas fa-vial me-1"></i>${testCase.id}</h6>
                <button class="btn btn-sm btn-outline-secondary" onclick="copyTestCase(${index})">
                    <i class="fas fa-copy me-1"></i>Sao ch√©p
                </button>
            </div>
            <div class="card-body">
                <p><strong>M·ª•c ƒë√≠ch:</strong> ${testCase.purpose}</p>
                <p><strong>K·ªãch b·∫£n:</strong> ${testCase.scenerio}</p>
                <p><strong>D·ªØ li·ªáu test:</strong> <span class="badge bg-info">${testCase.test_data}</span></p>
                
                <div class="row">
                    <div class="col-md-6">
                        <h6>C√°c b∆∞·ªõc:</h6>
                        <ol class="small">
                            ${testCase.steps.map(step => `<li>${step}</li>`).join('')}
                        </ol>
                    </div>
                    <div class="col-md-6">
                        <h6>K·∫øt qu·∫£ mong ƒë·ª£i:</h6>
                        <ol class="small">
                            ${testCase.expected.map(exp => `<li>${exp}</li>`).join('')}
                        </ol>
                    </div>
                </div>
                
                ${testCase.note ? `<p><small class="text-muted"><i class="fas fa-sticky-note me-1"></i>${testCase.note}</small></p>` : ''}
                
                <div class="mt-2">
                    <button class="btn btn-sm btn-primary" onclick="addToTestCases(${index})">
                        <i class="fas fa-plus me-1"></i>Th√™m v√†o danh s√°ch
                    </button>
                </div>
            </div>
        </div>`;
    });
    
    resultsContent.innerHTML = html;
    document.getElementById('resultsCard').style.display = 'block';
    
    // Store results for export
    window.generatedTestCases = testCases;
    window.lastGenerationData = data;
}

function copyTestCase(index) {
    const testCase = window.generatedTestCases[index];
    const jsonString = JSON.stringify(testCase, null, 2);
    
    navigator.clipboard.writeText(jsonString).then(() => {
        // Show success feedback
        const btn = event.target.closest('button');
        const originalText = btn.innerHTML;
        btn.innerHTML = '<i class="fas fa-check me-1"></i>ƒê√£ sao ch√©p!';
        btn.classList.add('btn-success');
        btn.classList.remove('btn-outline-secondary');
        
        setTimeout(() => {
            btn.innerHTML = originalText;
            btn.classList.remove('btn-success');
            btn.classList.add('btn-outline-secondary');
        }, 2000);
    });
}

function addToTestCases(index) {
    const testCase = window.generatedTestCases[index];
    
    // In a real implementation, this would make an API call to add the test case
    if (confirm(`Th√™m Test Case "${testCase.id}" v√†o c∆° s·ªü d·ªØ li·ªáu?`)) {
        // Simulate adding to database
        alert('Test Case s·∫Ω ƒë∆∞·ª£c th√™m v√†o c∆° s·ªü d·ªØ li·ªáu trong phi√™n b·∫£n th·ª±c t·∫ø');
    }
}

function exportResults() {
    if (!window.generatedTestCases) {
        alert('Kh√¥ng c√≥ Test Case n√†o ƒë·ªÉ xu·∫•t');
        return;
    }
    
    const jsonString = JSON.stringify(window.generatedTestCases, null, 2);
    const blob = new Blob([jsonString], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    
    const a = document.createElement('a');
    a.href = url;
    a.download = `generated_test_cases_${new Date().toISOString().slice(0, 10)}.json`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
}

function showFinalPrompt() {
    if (!window.lastGenerationData || !window.lastGenerationData.final_prompt) {
        alert('Kh√¥ng c√≥ th√¥ng tin prompt. Vui l√≤ng t·∫°o Test Case tr∆∞·ªõc.');
        return;
    }
    
    const data = window.lastGenerationData;
    
    // Populate modal content
    document.getElementById('contextUsed').value = data.context_used || 'Kh√¥ng c√≥ context';
    document.getElementById('finalPromptContent').value = data.final_prompt || 'Kh√¥ng c√≥ prompt';
    
    // Update statistics
    const promptLength = (data.final_prompt || '').length;
    const contextLines = (data.context_used || '').split('\n').length;
    const promptType = data.used_custom_prompt ? 'T√πy ch·ªânh' : 'M·∫∑c ƒë·ªãnh';
    
    document.getElementById('promptLength').textContent = promptLength.toLocaleString();
    document.getElementById('contextCount').textContent = Math.floor(contextLines / 10); // Rough estimate
    document.getElementById('promptType').textContent = promptType;
    
    // Show modal
    const modal = new bootstrap.Modal(document.getElementById('finalPromptModal'));
    modal.show();
}

function copyFinalPrompt() {
    const promptContent = document.getElementById('finalPromptContent').value;
    
    if (!promptContent) {
        alert('Kh√¥ng c√≥ prompt ƒë·ªÉ sao ch√©p');
        return;
    }
    
    navigator.clipboard.writeText(promptContent).then(() => {
        // Show success feedback
        const btn = event.target.closest('button');
        const originalText = btn.innerHTML;
        btn.innerHTML = '<i class="fas fa-check me-1"></i>ƒê√£ sao ch√©p!';
        btn.classList.add('btn-success');
        btn.classList.remove('btn-outline-secondary');
        
        setTimeout(() => {
            btn.innerHTML = originalText;
            btn.classList.remove('btn-success');
            btn.classList.add('btn-outline-secondary');
        }, 2000);
    }).catch(() => {
        alert('Kh√¥ng th·ªÉ sao ch√©p. Vui l√≤ng ch·ªçn v√† copy th·ªß c√¥ng.');
    });
}

function clearInput() {
    document.getElementById('apiInput').value = '';
    document.getElementById('resultsCard').style.display = 'none';
    document.getElementById('loadingCard').style.display = 'none';
}

function loadSampleAPI() {
    document.getElementById('apiInput').value = `# Payment API Documentation

## Overview
This API handles automatic payment processing for outstanding loans when customers deposit money into their wallets.

## Endpoints

### POST /api/v1/payment/auto
Automatically deduct outstanding loan amounts when customer deposits money.

**Request:**
- customer_id: string (required)
- amount: number (required) 
- wallet_id: string (required)

**Response:**
- status: success/error
- transaction_id: string
- deducted_amount: number

## Business Flow
1. Customer deposits money into wallet
2. System checks for outstanding loans
3. If loans exist, automatically deduct amounts
4. Update loan status and wallet balance
5. Send notifications

## Error Scenarios
- Insufficient balance
- API timeout (30s)
- Lender service unavailable
- Database transaction failure`;
}

function loadUserAPI() {
    document.getElementById('apiInput').value = `# User Management API

## Overview
Manages user registration, authentication, and profile updates.

## Endpoints

### POST /api/v1/users/register
Register a new user account.

### PUT /api/v1/users/profile
Update user profile information.

### DELETE /api/v1/users/{id}
Deactivate user account.

## Validation Rules
- Email must be unique
- Password minimum 8 characters
- Phone number format validation

## Error Handling
- Duplicate email: 409 Conflict
- Invalid data: 400 Bad Request
- User not found: 404 Not Found`;
}

function loadOrderAPI() {
    document.getElementById('apiInput').value = `# Order Processing API

## Overview
Handles order creation, payment processing, and fulfillment.

## Endpoints

### POST /api/v1/orders
Create a new order.

### PUT /api/v1/orders/{id}/status
Update order status.

### GET /api/v1/orders/{id}/tracking
Get order tracking information.

## Order States
- PENDING -> CONFIRMED -> PROCESSING -> SHIPPED -> DELIVERED
- PENDING -> CANCELLED

## Integration Points
- Payment gateway
- Inventory system
- Shipping providers
- Notification service`;
}

function embedDocuments() {
    const embedBtn = document.getElementById('embedBtn');
    const progressContainer = document.getElementById('embeddingProgress');
    const progressBar = document.getElementById('progressBar');
    const progressText = document.getElementById('progressText');
    
    // Disable button and show progress
    embedBtn.disabled = true;
    embedBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>ƒêang embedding...';
    progressContainer.style.display = 'block';
    progressBar.style.width = '10%';
    progressText.textContent = 'B·∫Øt ƒë·∫ßu qu√° tr√¨nh embedding...';
    
    fetch('/embed-documents', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Simulate progress completion
            progressBar.style.width = '100%';
            progressText.textContent = data.message || 'Embedding ho√†n th√†nh th√†nh c√¥ng!';
            
            setTimeout(() => {
                progressContainer.style.display = 'none';
                embedBtn.disabled = false;
                embedBtn.innerHTML = '<i class="fas fa-database me-1"></i>Embedding d·ªØ li·ªáu';
                
                // Refresh status
                refreshStatus();
                
                // Show success message
                alert('Embedding d·ªØ li·ªáu th√†nh c√¥ng! B√¢y gi·ªù b·∫°n c√≥ th·ªÉ s·ª≠ d·ª•ng RAG generator.');
            }, 2000);
        } else {
            progressContainer.style.display = 'none';
            embedBtn.disabled = false;
            embedBtn.innerHTML = '<i class="fas fa-database me-1"></i>Embedding d·ªØ li·ªáu';
            alert('L·ªói khi embedding d·ªØ li·ªáu: ' + data.error);
        }
    })
    .catch(error => {
        progressContainer.style.display = 'none';
        embedBtn.disabled = false;
        embedBtn.innerHTML = '<i class="fas fa-database me-1"></i>Embedding d·ªØ li·ªáu';
        alert('L·ªói khi embedding d·ªØ li·ªáu: ' + error);
    });
}

function refreshStatus() {
    fetch('/rag-status')
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            updateStatusDisplay(data.status);
        } else {
            console.error('Error getting RAG status:', data.error);
        }
    })
    .catch(error => {
        console.error('Error getting RAG status:', error);
    });
}

function updateStatusDisplay(status) {
    const container = document.getElementById('ragStatusContainer');
    
    const statusHtml = `
        <div class="mb-3">
            <div class="d-flex justify-content-between align-items-center mb-2">
                <span class="small">ƒê√£ kh·ªüi t·∫°o:</span>
                <span class="badge bg-${status.initialized ? 'success' : 'danger'}">
                    ${status.initialized ? 'C√≥' : 'Kh√¥ng'}
                </span>
            </div>
            <div class="d-flex justify-content-between align-items-center mb-2">
                <span class="small">ƒê√£ embedding:</span>
                <span class="badge bg-${status.embedded ? 'success' : 'warning'}">
                    ${status.embedded ? 'C√≥' : 'Ch∆∞a'}
                </span>
            </div>
            <div class="d-flex justify-content-between align-items-center mb-2">
                <span class="small">Vector Store:</span>
                <span class="badge bg-${status.vectorstore_ready ? 'success' : 'danger'}">
                    ${status.vectorstore_ready ? 'S·∫µn s√†ng' : 'Ch∆∞a s·∫µn s√†ng'}
                </span>
            </div>
        </div>
        
        ${!status.embedded ? `
        <div class="alert alert-warning py-2 mb-3">
            <i class="fas fa-exclamation-triangle me-1"></i>
            <small>C·∫ßn embedding d·ªØ li·ªáu ƒë·ªÉ RAG ho·∫°t ƒë·ªông ƒë√∫ng c√°ch.</small>
        </div>
        ` : ''}
        
        <div class="d-grid gap-2">
            <button type="button" class="btn btn-primary" onclick="embedDocuments()" id="embedBtn">
                <i class="fas fa-database me-1"></i>Embedding d·ªØ li·ªáu
            </button>
            <button type="button" class="btn btn-outline-secondary" onclick="refreshStatus()">
                <i class="fas fa-refresh me-1"></i>L√†m m·ªõi tr·∫°ng th√°i
            </button>
        </div>
    `;
    
    // Update only the status part, preserve the progress container
    const progressContainer = document.getElementById('embeddingProgress');
    container.innerHTML = statusHtml;
    container.appendChild(progressContainer);
}

// Async loading improvements
document.addEventListener('DOMContentLoaded', function() {
    // Load non-critical components asynchronously
    setTimeout(() => {
        loadBusinessFlowsAsync();
        loadSampleTemplatesAsync();
    }, 100);
});

function loadBusinessFlowsAsync() {
    // Load business flows asynchronously if not already loaded
    const flowsContainer = document.querySelector('.card-body .border-bottom');
    if (!flowsContainer) {
        fetch('/api/business-flows')
            .then(response => response.json())
            .then(data => {
                if (data.success && data.flows.length > 0) {
                    updateFlowsDisplay(data.flows);
                }
            })
            .catch(error => console.log('Async flows loading failed:', error));
    }
}

function loadSampleTemplatesAsync() {
    // Pre-load sample templates
    const sampleButtons = document.querySelectorAll('[onclick*="loadSample"]');
    sampleButtons.forEach(button => {
        button.addEventListener('mouseenter', function() {
            // Pre-load content on hover for better UX
            const methodName = this.getAttribute('onclick').match(/load(\w+)API/);
            if (methodName && methodName[1]) {
                // Could implement pre-loading here
            }
        });
    });
}

function updateFlowsDisplay(flows) {
    const container = document.querySelector('.card-body');
    if (container && flows.length > 0) {
        let html = '';
        flows.slice(0, 10).forEach(flow => {
            html += `
            <div class="border-bottom py-2">
                <strong>Step ${flow.step}:</strong> ${flow.actor}
                <br><small class="text-muted">${flow.description ? flow.description.substring(0, 100) + '...' : ''}</small>
            </div>`;
        });
        container.innerHTML = '<div style="max-height: 300px; overflow-y: auto;">" + html + "</div>';
    }
}

// Improved loading indicators
function showLoadingState(message = 'ƒêang x·ª≠ l√Ω...') {
    const loadingCard = document.getElementById('loadingCard');
    const loadingText = loadingCard.querySelector('h6');
    loadingText.textContent = message;
    loadingCard.style.display = 'block';
}

function hideLoadingState() {
    document.getElementById('loadingCard').style.display = 'none';
}

// Cache refresh functionality
function refreshAllCaches() {
    fetch('/api/invalidate-cache', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({})
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Refresh the page data
            location.reload();
        }
    })
    .catch(error => console.error('Cache refresh failed:', error));
}

// Reset system functionality
function resetSystem() {
    if (!confirm('‚ö†Ô∏è C·∫¢NH B√ÅO: B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën reset to√†n b·ªô h·ªá th·ªëng?\n\nVi·ªác n√†y s·∫Ω:\n‚Ä¢ X√≥a t·∫•t c·∫£ Test Case trong database\n‚Ä¢ X√≥a t·∫•t c·∫£ d·ªØ li·ªáu RAG ƒë√£ embedding\n‚Ä¢ Reset vector store v·ªÅ tr·∫°ng th√°i ban ƒë·∫ßu\n\nH√†nh ƒë·ªông n√†y KH√îNG TH·ªÇ HO√ÄN T√ÅC!')) {
        return;
    }
    
    // Double confirmation for safety
    if (!confirm('üî¥ X√ÅC NH·∫¨N L·∫¶N CU·ªêI:\n\nB·∫°n th·ª±c s·ª± mu·ªën X√ìA T·∫§T C·∫¢ d·ªØ li·ªáu?\nG√µ "X√ÅC NH·∫¨N" ƒë·ªÉ ti·∫øp t·ª•c.')) {
        return;
    }
    
    const userConfirmation = prompt('ƒê·ªÉ x√°c nh·∫≠n, vui l√≤ng g√µ ch√≠nh x√°c: X√ÅC NH·∫¨N');
    if (userConfirmation !== 'X√ÅC NH·∫¨N') {
        alert('ƒê√£ h·ªßy thao t√°c reset.');
        return;
    }
    
    // Show loading state
    const resetBtn = event.target.closest('button');
    const originalText = resetBtn.innerHTML;
    resetBtn.disabled = true;
    resetBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>ƒêang reset...';
    
    // Call reset API
    fetch('/reset-system', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            confirm: true,
            timestamp: new Date().toISOString()
        })
    })
    .then(response => response.json())
    .then(data => {
        resetBtn.disabled = false;
        resetBtn.innerHTML = originalText;
        
        if (data.success) {
            alert('‚úÖ Reset th√†nh c√¥ng!\n\n' + data.message);
            
            // Clear UI elements
            clearInput();
            document.getElementById('resultsCard').style.display = 'none';
            document.getElementById('loadingCard').style.display = 'none';
            
            // Reset prompt to default
            currentPromptType = 'default';
            updatePromptIndicator();
            
            // Refresh status
            refreshStatus();
            
            // Optionally reload page for complete reset
            setTimeout(() => {
                if (confirm('T·∫£i l·∫°i trang ƒë·ªÉ ho√†n t·∫•t reset?')) {
                    location.reload();
                }
            }, 2000);
        } else {
            alert('‚ùå L·ªói khi reset h·ªá th·ªëng:\n' + data.error);
        }
    })
    .catch(error => {
        resetBtn.disabled = false;
        resetBtn.innerHTML = originalText;
        alert('‚ùå L·ªói k·∫øt n·ªëi khi reset h·ªá th·ªëng:\n' + error);
        console.error('Reset system error:', error);
    });
}
</script>
{% endblock %}