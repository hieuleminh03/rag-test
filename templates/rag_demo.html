{% extends "base.html" %}

{% block title %}RAG Generator - Tạo Test Case{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <div>
        <h2><i class="fas fa-magic me-2"></i>RAG Generator</h2>
        <p class="text-muted mb-0">Tạo Test Case tự động từ tài liệu API</p>
    </div>
    <button type="button" class="btn btn-outline-secondary" onclick="loadSampleAPI()">
        <i class="fas fa-file-alt me-1"></i>Tải mẫu API
    </button>
</div>

<div class="row">
    <div class="col-lg-8">
        <!-- API Input -->
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-code me-2"></i>Nhập tài liệu API</h5>
            </div>
            <div class="card-body">
                <form id="ragForm">
                    <div class="mb-3">
                        <label for="apiInput" class="form-label">Dán tài liệu API vào đây:</label>
                        <textarea class="form-control" id="apiInput" name="api_input" rows="12" 
                                  placeholder="Dán tài liệu API (định dạng Markdown) vào đây...">{{ api_doc if api_doc else '' }}</textarea>
                        <div class="form-text text-muted">
                            <i class="fas fa-info-circle me-1"></i>
                            Hệ thống RAG sẽ phân tích tài liệu này và tạo Test Case dựa trên các mẫu tương tự trong cơ sở dữ liệu.
                        </div>
                    </div>
                    
                    <!-- Custom Prompt Indicator -->
                    <div id="customPromptIndicator" class="alert alert-info py-2 mb-3" style="display: none;">
                        <i class="fas fa-edit me-1"></i>
                        <small><strong>Đang sử dụng prompt tùy chỉnh.</strong> 
                        <a href="#" onclick="resetToDefaultPrompt()" class="alert-link">Khôi phục mặc định</a></small>
                    </div>
                    
                    <div class="d-flex gap-2 justify-content-end">
                        <button type="button" class="btn btn-outline-secondary" onclick="clearInput()">
                            <i class="fas fa-eraser me-1"></i>Xóa
                        </button>
                        <button type="button" class="btn btn-outline-primary" onclick="reviewPrompt()" id="promptBtn">
                            <i class="fas fa-eye me-1"></i>Xem Prompt
                        </button>
                        <button type="button" class="btn btn-primary" onclick="generateTestCases()">
                            <i class="fas fa-magic me-1"></i>Tạo Test Case
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Generated Results -->
        <div class="card mt-4" id="resultsCard" style="display: none;">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0"><i class="fas fa-list-check me-2"></i>Test Case đã tạo</h5>
                <div class="btn-group">
                    <button type="button" class="btn btn-sm btn-outline-info" onclick="showFinalPrompt()">
                        <i class="fas fa-eye me-1"></i>Xem Prompt đã gửi
                    </button>
                    <button type="button" class="btn btn-sm btn-outline-secondary" onclick="exportResults()">
                        <i class="fas fa-download me-1"></i>Xuất file
                    </button>
                </div>
            </div>
            <div class="card-body" id="resultsContent">
                <!-- Generated test cases will appear here -->
            </div>
        </div>

        <!-- Loading Indicator -->
        <div class="card mt-4" id="loadingCard" style="display: none;">
            <div class="card-body text-center py-5">
                <div class="spinner-border text-primary mb-3" role="status">
                    <span class="visually-hidden">Đang tải...</span>
                </div>
                <h6>Đang phân tích tài liệu API và tạo Test Case...</h6>
                <small class="text-muted">Quá trình này có thể mất vài phút</small>
            </div>
        </div>
    </div>

    <div class="col-lg-4">
        <!-- RAG Status & Control -->
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-robot me-2"></i>Trạng thái hệ thống RAG</h5>
            </div>
            <div class="card-body">
                <div id="ragStatusContainer">
                    {% if rag_status %}
                    <div class="mb-3">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <span class="small">Đã khởi tạo:</span>
                            <span class="badge bg-{{ 'success' if rag_status.initialized else 'danger' }}">
                                {{ 'Có' if rag_status.initialized else 'Không' }}
                            </span>
                        </div>
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <span class="small">Đã embedding:</span>
                            <span class="badge bg-{{ 'success' if rag_status.embedded else 'warning' }}">
                                {{ 'Có' if rag_status.embedded else 'Chưa' }}
                            </span>
                        </div>
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <span class="small">Vector Store:</span>
                            <span class="badge bg-{{ 'success' if rag_status.vectorstore_ready else 'danger' }}">
                                {{ 'Sẵn sàng' if rag_status.vectorstore_ready else 'Chưa sẵn sàng' }}
                            </span>
                        </div>
                    </div>
                    {% endif %}
                    
                    {% if not rag_status.embedded %}
                    <div class="alert alert-warning py-2 mb-3">
                        <i class="fas fa-exclamation-triangle me-1"></i>
                        <small>Cần embedding dữ liệu để RAG hoạt động đúng cách.</small>
                    </div>
                    {% endif %}
                    
                    <div class="d-grid gap-2">
                        <button type="button" class="btn btn-primary" onclick="embedDocuments()" id="embedBtn">
                            <i class="fas fa-database me-1"></i>Embedding dữ liệu
                        </button>
                        <button type="button" class="btn btn-outline-secondary" onclick="refreshStatus()">
                            <i class="fas fa-refresh me-1"></i>Làm mới trạng thái
                        </button>
                        <button type="button" class="btn btn-outline-info" onclick="refreshAllCaches()">
                            <i class="fas fa-sync-alt me-1"></i>Làm mới cache
                        </button>
                    </div>
                </div>
                
                <!-- Embedding Progress -->
                <div id="embeddingProgress" style="display: none;" class="mt-3">
                    <div class="progress mb-2">
                        <div class="progress-bar progress-bar-striped progress-bar-animated" 
                             role="progressbar" style="width: 0%" id="progressBar"></div>
                    </div>
                    <small class="text-muted" id="progressText">Đang khởi tạo...</small>
                </div>
            </div>
        </div>

        <!-- RAG Process Info -->
        <div class="card mt-4">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-info-circle me-2"></i>Cách thức hoạt động của RAG</h5>
            </div>
            <div class="card-body">
                <ol class="small mb-3">
                    <li><strong>Phân tích tài liệu:</strong> Phân tích cấu trúc tài liệu API</li>
                    <li><strong>Tìm kiếm Vector:</strong> Tìm Test Case tương tự trong cơ sở dữ liệu</li>
                    <li><strong>Xây dựng Context:</strong> Kết hợp các ví dụ liên quan</li>
                    <li><strong>Tạo bằng LLM:</strong> Tạo Test Case mới sử dụng Gemini</li>
                    <li><strong>Kiểm tra:</strong> Đảm bảo Test Case tuân theo định dạng</li>
                </ol>
                
                <div class="border-top pt-3">
                    <h6 class="mb-2">Cơ sở dữ liệu hiện tại:</h6>
                    <ul class="small mb-0">
                        <li>{{ total_test_cases }} Test Case toàn diện</li>
                        <li>Tìm kiếm Top-5 tương tự</li>
                        <li>Tập trung vào logic nghiệp vụ</li>
                        <li>Hỗ trợ tiếng Việt + tiếng Anh</li>
                    </ul>
                </div>
            </div>
        </div>

        <!-- Suggestions -->
        {% if suggestions %}
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="card-title mb-0"><i class="fas fa-lightbulb"></i> Detected Scenarios</h5>
            </div>
            <div class="card-body">
                {% for suggestion in suggestions %}
                <div class="alert alert-{{ 'danger' if suggestion.priority == 'high' else 'warning' if suggestion.priority == 'medium' else 'info' }} py-2">
                    <strong>{{ suggestion.category.title() }}:</strong> {{ suggestion.description }}
                    <br><small>{{ suggestion.rationale }}</small>
                </div>
                {% endfor %}
            </div>
        </div>
        {% endif %}

        <!-- Business Flows -->
        {% if flows %}
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="card-title mb-0"><i class="fas fa-sitemap"></i> Business Flows</h5>
            </div>
            <div class="card-body">
                <div style="max-height: 300px; overflow-y: auto;">
                    {% for flow in flows %}
                    <div class="border-bottom py-2">
                        <strong>Step {{ flow.step }}:</strong> {{ flow.actor }}
                        <br><small class="text-muted">{{ flow.description[:100] }}{% if flow.description|length > 100 %}...{% endif %}</small>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
        {% endif %}

        <!-- Sample Templates -->
        <div class="card mt-4">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-file-alt me-2"></i>Mẫu tài liệu API</h5>
            </div>
            <div class="card-body">
                <div class="d-grid gap-2">
                    <button type="button" class="btn btn-outline-primary" onclick="loadSampleAPI()">
                        <i class="fas fa-wallet me-1"></i>Payment API
                    </button>
                    <button type="button" class="btn btn-outline-info" onclick="loadUserAPI()">
                        <i class="fas fa-user me-1"></i>User Management
                    </button>
                    <button type="button" class="btn btn-outline-success" onclick="loadOrderAPI()">
                        <i class="fas fa-shopping-cart me-1"></i>Order Processing
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Prompt Review Modal -->
<div class="modal fade" id="promptModal" tabindex="-1" aria-labelledby="promptModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="promptModalLabel">
                    <i class="fas fa-eye me-2"></i>Xem và chỉnh sửa Prompt
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-info">
                    <i class="fas fa-info-circle me-1"></i>
                    <strong>Hướng dẫn:</strong> Bạn có thể chỉnh sửa prompt để tùy chỉnh cách RAG tạo Test Case. 
                    Các biến <code>{context}</code> và <code>{question}</code> sẽ được thay thế tự động.
                </div>
                
                <div class="mb-3">
                    <label for="promptText" class="form-label">
                        <strong>Prompt Template:</strong>
                    </label>
                    <textarea class="form-control" id="promptText" rows="20" style="font-family: monospace; font-size: 12px;"></textarea>
                </div>
                
                <div class="row">
                    <div class="col-md-6">
                        <h6>Biến có sẵn:</h6>
                        <ul class="small">
                            <li><code>{context}</code> - Test Case tương tự từ database</li>
                            <li><code>{question}</code> - Tài liệu API đầu vào</li>
                        </ul>
                    </div>
                    <div class="col-md-6">
                        <h6>Mẹo tùy chỉnh:</h6>
                        <ul class="small">
                            <li>Thay đổi số lượng Test Case cần tạo</li>
                            <li>Điều chỉnh focus (security, performance, etc.)</li>
                            <li>Thêm yêu cầu đặc biệt cho dự án</li>
                        </ul>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline-secondary" onclick="resetPrompt()">
                    <i class="fas fa-undo me-1"></i>Khôi phục mặc định
                </button>
                <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times me-1"></i>Hủy
                </button>
                <button type="button" class="btn btn-primary" onclick="savePromptAndGenerate()">
                    <i class="fas fa-magic me-1"></i>Lưu và tạo Test Case
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Final Prompt Modal -->
<div class="modal fade" id="finalPromptModal" tabindex="-1" aria-labelledby="finalPromptModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="finalPromptModalLabel">
                    <i class="fas fa-eye me-2"></i>Prompt đã gửi tới LLM
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-info">
                    <i class="fas fa-info-circle me-1"></i>
                    <strong>Thông tin:</strong> Đây là prompt cuối cùng đã được gửi tới Google Gemini, 
                    bao gồm context từ RAG và tài liệu API của bạn.
                </div>
                
                <div class="mb-3">
                    <label class="form-label">
                        <strong>Context từ RAG (Test Case tương tự):</strong>
                    </label>
                    <textarea class="form-control" id="contextUsed" rows="8" readonly 
                              style="font-family: monospace; font-size: 11px; background-color: #f8f9fa;"></textarea>
                </div>
                
                <div class="mb-3">
                    <label class="form-label">
                        <strong>Prompt hoàn chỉnh đã gửi:</strong>
                    </label>
                    <textarea class="form-control" id="finalPromptContent" rows="15" readonly 
                              style="font-family: monospace; font-size: 11px; background-color: #f8f9fa;"></textarea>
                </div>
                
                <div class="row">
                    <div class="col-md-6">
                        <h6>Thống kê:</h6>
                        <ul class="small" id="promptStats">
                            <li>Độ dài prompt: <span id="promptLength">-</span> ký tự</li>
                            <li>Số Test Case context: <span id="contextCount">-</span></li>
                            <li>Loại prompt: <span id="promptType">-</span></li>
                        </ul>
                    </div>
                    <div class="col-md-6">
                        <h6>Ghi chú:</h6>
                        <ul class="small">
                            <li>Context được lấy từ vector similarity search</li>
                            <li>Prompt được format với {context} và {question}</li>
                            <li>LLM: Google Gemini 1.5 Pro</li>
                        </ul>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline-secondary" onclick="copyFinalPrompt()">
                    <i class="fas fa-copy me-1"></i>Sao chép Prompt
                </button>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times me-1"></i>Đóng
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Default prompt template (Vietnamese)
const DEFAULT_PROMPT = `Bạn là một chuyên gia tạo test case chuyên về phân tích tài liệu API và tạo ra các kịch bản kiểm thử toàn diện.

## TỔNG QUAN NHIỆM VỤ
Phân tích tài liệu API được cung cấp và tạo ra các test case chi tiết bao phủ các luồng logic nghiệp vụ, tập trung vào các kịch bản thực tế và các trường hợp biên.

## PHÂN TÍCH NGỮ CẢNH
Nghiên cứu các test case tương tự này để hiểu định dạng mong đợi và các mẫu bao phủ:
{context}

## TÀI LIỆU API CẦN PHÂN TÍCH
{question}

## YÊU CẦU TẠO TEST CASE

### Cấu trúc JSON (BẮT BUỘC)
Mỗi test case phải tuân theo cấu trúc chính xác này:
\`\`\`json
{
  "id": "id_test_mô_tả_với_kịch_bản",
  "purpose": "Mục đích nghiệp vụ rõ ràng của test",
  "scenerio": "Kịch bản cụ thể được kiểm thử với các điều kiện",
  "test_data": "Nguồn dữ liệu cần thiết, bảng DB, hoặc dữ liệu mock",
  "steps": [
    "1. Bước chi tiết với actor và hành động",
    "2. Bao gồm tương tác hệ thống và API calls",
    "3. Chỉ định các thao tác database và validation"
  ],
  "expected": [
    "1. Hành vi hệ thống mong đợi với status/giá trị cụ thể",
    "2. Thay đổi trạng thái database với chi tiết bảng và trường",
    "3. Định dạng phản hồi API và mã lỗi nếu có"
  ],
  "note": "Tham chiếu API, quy tắc nghiệp vụ, hoặc ràng buộc kỹ thuật"
}
\`\`\`

### CÁC LĨNH VỰC BAO PHỦ (Tạo test case cho mỗi lĩnh vực có thể áp dụng)

1. **Kịch bản Đường Đi Hạnh Phúc**
   - Thực thi luồng nghiệp vụ bình thường
   - Tích hợp API thành công
   - Cập nhật database đúng cách

2. **Xử Lý Lỗi & Trường Hợp Biên**
   - Timeout API và lỗi kết nối
   - Dữ liệu đầu vào không hợp lệ và lỗi validation
   - Hệ thống không khả dụng và chế độ bảo trì
   - Tài nguyên không đủ (số dư, quota, v.v.)

3. **Validation Logic Nghiệp Vụ**
   - Luồng có điều kiện và điểm quyết định
   - Chuyển đổi và tính toán dữ liệu
   - Chuyển đổi trạng thái và cập nhật status
   - Validation quy trình nhiều bước

4. **Tích Hợp & Đồng Thời**
   - Giao tiếp hệ thống bên ngoài
   - Tính nhất quán giao dịch database
   - Xử lý request đồng thời
   - Ngăn chặn race condition

5. **Tính Nhất Quán Dữ Liệu & Rollback**
   - Kịch bản rollback giao dịch
   - Validation tính toàn vẹn dữ liệu
   - Kiểm tra tính nhất quán cross-table
   - Xác minh audit trail

### QUY ƯỚC ĐẶT TÊN
- ID: Sử dụng định dạng "danh_mục-kịch_bản_số" (ví dụ: "thanh_toan-timeout_1", "validation-san_pham_khong_hop_le_1")
- Mô tả cụ thể và chi tiết về kịch bản được kiểm thử

### CHI TIẾT KỸ THUẬT CẦN BAO GỒM
- Bảng và trường database cụ thể
- Tham chiếu endpoint API và phiên bản
- Mã status và thông báo lỗi
- Ràng buộc thời gian và timeout
- Phụ thuộc cấu hình (CMS, v.v.)

## YÊU CẦU ĐẦU RA
Tạo 5-8 test case toàn diện bao phủ các khía cạnh khác nhau của tài liệu API. Đảm bảo mỗi test case là:
- **Cụ thể**: Kịch bản rõ ràng với điều kiện chính xác
- **Có thể thực hiện**: Các bước chi tiết có thể được thực thi
- **Có thể xác minh**: Kết quả mong đợi có thể đo lường
- **Thực tế**: Dựa trên yêu cầu nghiệp vụ thực tế

Tập trung vào kiểm thử logic nghiệp vụ, không phải validation cơ bản. Mỗi test nên đại diện cho một hành trình người dùng có ý nghĩa hoặc tương tác hệ thống.

## CÁC TEST CASE ĐƯỢC TẠO:`;

// Store current prompt
let currentPrompt = DEFAULT_PROMPT;

function reviewPrompt() {
    const apiInput = document.getElementById('apiInput').value.trim();
    
    if (!apiInput) {
        alert('Vui lòng nhập tài liệu API trước khi xem prompt');
        return;
    }
    
    // Load current prompt into modal
    document.getElementById('promptText').value = currentPrompt;
    
    // Show modal
    const modal = new bootstrap.Modal(document.getElementById('promptModal'));
    modal.show();
}

function resetPrompt() {
    document.getElementById('promptText').value = DEFAULT_PROMPT;
    currentPrompt = DEFAULT_PROMPT;
}

function savePromptAndGenerate() {
    // Save the edited prompt
    currentPrompt = document.getElementById('promptText').value;
    
    // Update UI to show custom prompt is being used
    updatePromptIndicator();
    
    // Close modal
    const modal = bootstrap.Modal.getInstance(document.getElementById('promptModal'));
    modal.hide();
    
    // Generate test cases with custom prompt
    generateTestCases(true);
}

function resetToDefaultPrompt() {
    currentPrompt = DEFAULT_PROMPT;
    updatePromptIndicator();
}

function updatePromptIndicator() {
    const indicator = document.getElementById('customPromptIndicator');
    const promptBtn = document.getElementById('promptBtn');
    
    if (currentPrompt !== DEFAULT_PROMPT) {
        // Show custom prompt indicator
        indicator.style.display = 'block';
        promptBtn.innerHTML = '<i class="fas fa-edit me-1"></i>Chỉnh sửa Prompt';
        promptBtn.classList.remove('btn-outline-primary');
        promptBtn.classList.add('btn-warning');
    } else {
        // Hide indicator and reset button
        indicator.style.display = 'none';
        promptBtn.innerHTML = '<i class="fas fa-eye me-1"></i>Xem Prompt';
        promptBtn.classList.remove('btn-warning');
        promptBtn.classList.add('btn-outline-primary');
    }
}

function generateTestCases(useCustomPrompt = false) {
    const apiInput = document.getElementById('apiInput').value.trim();
    
    if (!apiInput) {
        alert('Vui lòng nhập tài liệu API');
        return;
    }
    
    // Show loading
    document.getElementById('loadingCard').style.display = 'block';
    document.getElementById('resultsCard').style.display = 'none';
    
    // Prepare request data
    let requestData = 'api_input=' + encodeURIComponent(apiInput);
    if (useCustomPrompt) {
        requestData += '&custom_prompt=' + encodeURIComponent(currentPrompt);
    }
    
    // API call
    fetch('/generate-test-cases', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
        },
        body: requestData
    })
    .then(response => response.json())
    .then(data => {
        document.getElementById('loadingCard').style.display = 'none';
        
        if (data.success) {
            displayResults(data.generated_cases, data);
        } else {
            alert('Lỗi: ' + data.error);
        }
    })
    .catch(error => {
        document.getElementById('loadingCard').style.display = 'none';
        alert('Lỗi khi tạo Test Case: ' + error);
    });
}

function displayResults(testCases, data = {}) {
    const resultsContent = document.getElementById('resultsContent');
    
    let html = `<div class="alert alert-success">
        <i class="fas fa-check-circle me-1"></i>Đã tạo thành công ${testCases.length} Test Case!
        ${data.used_custom_prompt ? '<br><small><i class="fas fa-edit me-1"></i>Sử dụng prompt tùy chỉnh</small>' : ''}
    </div>`;
    
    testCases.forEach((testCase, index) => {
        html += `
        <div class="card mb-3">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h6 class="mb-0"><i class="fas fa-vial me-1"></i>${testCase.id}</h6>
                <button class="btn btn-sm btn-outline-secondary" onclick="copyTestCase(${index})">
                    <i class="fas fa-copy me-1"></i>Sao chép
                </button>
            </div>
            <div class="card-body">
                <p><strong>Mục đích:</strong> ${testCase.purpose}</p>
                <p><strong>Kịch bản:</strong> ${testCase.scenerio}</p>
                <p><strong>Dữ liệu test:</strong> <span class="badge bg-info">${testCase.test_data}</span></p>
                
                <div class="row">
                    <div class="col-md-6">
                        <h6>Các bước:</h6>
                        <ol class="small">
                            ${testCase.steps.map(step => `<li>${step}</li>`).join('')}
                        </ol>
                    </div>
                    <div class="col-md-6">
                        <h6>Kết quả mong đợi:</h6>
                        <ol class="small">
                            ${testCase.expected.map(exp => `<li>${exp}</li>`).join('')}
                        </ol>
                    </div>
                </div>
                
                ${testCase.note ? `<p><small class="text-muted"><i class="fas fa-sticky-note me-1"></i>${testCase.note}</small></p>` : ''}
                
                <div class="mt-2">
                    <button class="btn btn-sm btn-primary" onclick="addToTestCases(${index})">
                        <i class="fas fa-plus me-1"></i>Thêm vào danh sách
                    </button>
                </div>
            </div>
        </div>`;
    });
    
    resultsContent.innerHTML = html;
    document.getElementById('resultsCard').style.display = 'block';
    
    // Store results for export
    window.generatedTestCases = testCases;
    window.lastGenerationData = data;
}

function copyTestCase(index) {
    const testCase = window.generatedTestCases[index];
    const jsonString = JSON.stringify(testCase, null, 2);
    
    navigator.clipboard.writeText(jsonString).then(() => {
        // Show success feedback
        const btn = event.target.closest('button');
        const originalText = btn.innerHTML;
        btn.innerHTML = '<i class="fas fa-check me-1"></i>Đã sao chép!';
        btn.classList.add('btn-success');
        btn.classList.remove('btn-outline-secondary');
        
        setTimeout(() => {
            btn.innerHTML = originalText;
            btn.classList.remove('btn-success');
            btn.classList.add('btn-outline-secondary');
        }, 2000);
    });
}

function addToTestCases(index) {
    const testCase = window.generatedTestCases[index];
    
    // In a real implementation, this would make an API call to add the test case
    if (confirm(`Thêm Test Case "${testCase.id}" vào cơ sở dữ liệu?`)) {
        // Simulate adding to database
        alert('Test Case sẽ được thêm vào cơ sở dữ liệu trong phiên bản thực tế');
    }
}

function exportResults() {
    if (!window.generatedTestCases) {
        alert('Không có Test Case nào để xuất');
        return;
    }
    
    const jsonString = JSON.stringify(window.generatedTestCases, null, 2);
    const blob = new Blob([jsonString], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    
    const a = document.createElement('a');
    a.href = url;
    a.download = `generated_test_cases_${new Date().toISOString().slice(0, 10)}.json`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
}

function showFinalPrompt() {
    if (!window.lastGenerationData || !window.lastGenerationData.final_prompt) {
        alert('Không có thông tin prompt. Vui lòng tạo Test Case trước.');
        return;
    }
    
    const data = window.lastGenerationData;
    
    // Populate modal content
    document.getElementById('contextUsed').value = data.context_used || 'Không có context';
    document.getElementById('finalPromptContent').value = data.final_prompt || 'Không có prompt';
    
    // Update statistics
    const promptLength = (data.final_prompt || '').length;
    const contextLines = (data.context_used || '').split('\n').length;
    const promptType = data.used_custom_prompt ? 'Tùy chỉnh' : 'Mặc định';
    
    document.getElementById('promptLength').textContent = promptLength.toLocaleString();
    document.getElementById('contextCount').textContent = Math.floor(contextLines / 10); // Rough estimate
    document.getElementById('promptType').textContent = promptType;
    
    // Show modal
    const modal = new bootstrap.Modal(document.getElementById('finalPromptModal'));
    modal.show();
}

function copyFinalPrompt() {
    const promptContent = document.getElementById('finalPromptContent').value;
    
    if (!promptContent) {
        alert('Không có prompt để sao chép');
        return;
    }
    
    navigator.clipboard.writeText(promptContent).then(() => {
        // Show success feedback
        const btn = event.target.closest('button');
        const originalText = btn.innerHTML;
        btn.innerHTML = '<i class="fas fa-check me-1"></i>Đã sao chép!';
        btn.classList.add('btn-success');
        btn.classList.remove('btn-outline-secondary');
        
        setTimeout(() => {
            btn.innerHTML = originalText;
            btn.classList.remove('btn-success');
            btn.classList.add('btn-outline-secondary');
        }, 2000);
    }).catch(() => {
        alert('Không thể sao chép. Vui lòng chọn và copy thủ công.');
    });
}

function clearInput() {
    document.getElementById('apiInput').value = '';
    document.getElementById('resultsCard').style.display = 'none';
    document.getElementById('loadingCard').style.display = 'none';
}

function loadSampleAPI() {
    document.getElementById('apiInput').value = `# Payment API Documentation

## Overview
This API handles automatic payment processing for outstanding loans when customers deposit money into their wallets.

## Endpoints

### POST /api/v1/payment/auto
Automatically deduct outstanding loan amounts when customer deposits money.

**Request:**
- customer_id: string (required)
- amount: number (required) 
- wallet_id: string (required)

**Response:**
- status: success/error
- transaction_id: string
- deducted_amount: number

## Business Flow
1. Customer deposits money into wallet
2. System checks for outstanding loans
3. If loans exist, automatically deduct amounts
4. Update loan status and wallet balance
5. Send notifications

## Error Scenarios
- Insufficient balance
- API timeout (30s)
- Lender service unavailable
- Database transaction failure`;
}

function loadUserAPI() {
    document.getElementById('apiInput').value = `# User Management API

## Overview
Manages user registration, authentication, and profile updates.

## Endpoints

### POST /api/v1/users/register
Register a new user account.

### PUT /api/v1/users/profile
Update user profile information.

### DELETE /api/v1/users/{id}
Deactivate user account.

## Validation Rules
- Email must be unique
- Password minimum 8 characters
- Phone number format validation

## Error Handling
- Duplicate email: 409 Conflict
- Invalid data: 400 Bad Request
- User not found: 404 Not Found`;
}

function loadOrderAPI() {
    document.getElementById('apiInput').value = `# Order Processing API

## Overview
Handles order creation, payment processing, and fulfillment.

## Endpoints

### POST /api/v1/orders
Create a new order.

### PUT /api/v1/orders/{id}/status
Update order status.

### GET /api/v1/orders/{id}/tracking
Get order tracking information.

## Order States
- PENDING -> CONFIRMED -> PROCESSING -> SHIPPED -> DELIVERED
- PENDING -> CANCELLED

## Integration Points
- Payment gateway
- Inventory system
- Shipping providers
- Notification service`;
}

function embedDocuments() {
    const embedBtn = document.getElementById('embedBtn');
    const progressContainer = document.getElementById('embeddingProgress');
    const progressBar = document.getElementById('progressBar');
    const progressText = document.getElementById('progressText');
    
    // Disable button and show progress
    embedBtn.disabled = true;
    embedBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Đang embedding...';
    progressContainer.style.display = 'block';
    progressBar.style.width = '10%';
    progressText.textContent = 'Bắt đầu quá trình embedding...';
    
    fetch('/embed-documents', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Simulate progress completion
            progressBar.style.width = '100%';
            progressText.textContent = data.message || 'Embedding hoàn thành thành công!';
            
            setTimeout(() => {
                progressContainer.style.display = 'none';
                embedBtn.disabled = false;
                embedBtn.innerHTML = '<i class="fas fa-database me-1"></i>Embedding dữ liệu';
                
                // Refresh status
                refreshStatus();
                
                // Show success message
                alert('Embedding dữ liệu thành công! Bây giờ bạn có thể sử dụng RAG generator.');
            }, 2000);
        } else {
            progressContainer.style.display = 'none';
            embedBtn.disabled = false;
            embedBtn.innerHTML = '<i class="fas fa-database me-1"></i>Embedding dữ liệu';
            alert('Lỗi khi embedding dữ liệu: ' + data.error);
        }
    })
    .catch(error => {
        progressContainer.style.display = 'none';
        embedBtn.disabled = false;
        embedBtn.innerHTML = '<i class="fas fa-database me-1"></i>Embedding dữ liệu';
        alert('Lỗi khi embedding dữ liệu: ' + error);
    });
}

function refreshStatus() {
    fetch('/rag-status')
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            updateStatusDisplay(data.status);
        } else {
            console.error('Error getting RAG status:', data.error);
        }
    })
    .catch(error => {
        console.error('Error getting RAG status:', error);
    });
}

function updateStatusDisplay(status) {
    const container = document.getElementById('ragStatusContainer');
    
    const statusHtml = `
        <div class="mb-3">
            <div class="d-flex justify-content-between align-items-center mb-2">
                <span class="small">Đã khởi tạo:</span>
                <span class="badge bg-${status.initialized ? 'success' : 'danger'}">
                    ${status.initialized ? 'Có' : 'Không'}
                </span>
            </div>
            <div class="d-flex justify-content-between align-items-center mb-2">
                <span class="small">Đã embedding:</span>
                <span class="badge bg-${status.embedded ? 'success' : 'warning'}">
                    ${status.embedded ? 'Có' : 'Chưa'}
                </span>
            </div>
            <div class="d-flex justify-content-between align-items-center mb-2">
                <span class="small">Vector Store:</span>
                <span class="badge bg-${status.vectorstore_ready ? 'success' : 'danger'}">
                    ${status.vectorstore_ready ? 'Sẵn sàng' : 'Chưa sẵn sàng'}
                </span>
            </div>
        </div>
        
        ${!status.embedded ? `
        <div class="alert alert-warning py-2 mb-3">
            <i class="fas fa-exclamation-triangle me-1"></i>
            <small>Cần embedding dữ liệu để RAG hoạt động đúng cách.</small>
        </div>
        ` : ''}
        
        <div class="d-grid gap-2">
            <button type="button" class="btn btn-primary" onclick="embedDocuments()" id="embedBtn">
                <i class="fas fa-database me-1"></i>Embedding dữ liệu
            </button>
            <button type="button" class="btn btn-outline-secondary" onclick="refreshStatus()">
                <i class="fas fa-refresh me-1"></i>Làm mới trạng thái
            </button>
        </div>
    `;
    
    // Update only the status part, preserve the progress container
    const progressContainer = document.getElementById('embeddingProgress');
    container.innerHTML = statusHtml;
    container.appendChild(progressContainer);
}

// Async loading improvements
document.addEventListener('DOMContentLoaded', function() {
    // Load non-critical components asynchronously
    setTimeout(() => {
        loadBusinessFlowsAsync();
        loadSampleTemplatesAsync();
    }, 100);
});

function loadBusinessFlowsAsync() {
    // Load business flows asynchronously if not already loaded
    const flowsContainer = document.querySelector('.card-body .border-bottom');
    if (!flowsContainer) {
        fetch('/api/business-flows')
            .then(response => response.json())
            .then(data => {
                if (data.success && data.flows.length > 0) {
                    updateFlowsDisplay(data.flows);
                }
            })
            .catch(error => console.log('Async flows loading failed:', error));
    }
}

function loadSampleTemplatesAsync() {
    // Pre-load sample templates
    const sampleButtons = document.querySelectorAll('[onclick*="loadSample"]');
    sampleButtons.forEach(button => {
        button.addEventListener('mouseenter', function() {
            // Pre-load content on hover for better UX
            const methodName = this.getAttribute('onclick').match(/load(\w+)API/);
            if (methodName && methodName[1]) {
                // Could implement pre-loading here
            }
        });
    });
}

function updateFlowsDisplay(flows) {
    const container = document.querySelector('.card-body');
    if (container && flows.length > 0) {
        let html = '';
        flows.slice(0, 10).forEach(flow => {
            html += `
            <div class="border-bottom py-2">
                <strong>Step ${flow.step}:</strong> ${flow.actor}
                <br><small class="text-muted">${flow.description ? flow.description.substring(0, 100) + '...' : ''}</small>
            </div>`;
        });
        container.innerHTML = '<div style="max-height: 300px; overflow-y: auto;">" + html + "</div>';
    }
}

// Improved loading indicators
function showLoadingState(message = 'Đang xử lý...') {
    const loadingCard = document.getElementById('loadingCard');
    const loadingText = loadingCard.querySelector('h6');
    loadingText.textContent = message;
    loadingCard.style.display = 'block';
}

function hideLoadingState() {
    document.getElementById('loadingCard').style.display = 'none';
}

// Cache refresh functionality
function refreshAllCaches() {
    fetch('/api/invalidate-cache', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({})
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Refresh the page data
            location.reload();
        }
    })
    .catch(error => console.error('Cache refresh failed:', error));
}
</script>
{% endblock %}